name: Rebase PR Submodules Automatically

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Base branch to rebase onto'
        required: true
        default: 'main'
      pr_branch:
        description: 'PR branch to rebase'
        required: true

permissions:
  contents: write

jobs:
  rebase-submodules:
    runs-on: ubuntu-latest
    env:
      RW_PAT: ${{ secrets.WORKFLOWS }}
    steps:
      - name: Checkout PR branch with submodules
        uses: actions/checkout@v4
        with:
          token: ${{ env.RW_PAT }}
          fetch-depth: 0
          ref: ${{ github.event.inputs.pr_branch }}
          submodules: recursive

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch base branch
        run: git fetch origin ${{ github.event.inputs.base_branch }}

      - name: Start rebase onto base branch
        run: |
          set -e
          git checkout ${{ github.event.inputs.pr_branch }}
          echo "Starting rebase onto ${{ github.event.inputs.base_branch }}..."
          git rebase origin/${{ github.event.inputs.base_branch }} || echo "⚠️ Rebase paused due to conflicts"

      - name: Detect conflicted submodules
        id: detect
        run: |
          conflicted=$(git diff --name-only --diff-filter=U)
          submodule_paths=$(git config --file .gitmodules --get-regexp path | awk '{print $2}')
          conflicted_submodules=""
          for sub in $submodule_paths; do
            if echo "$conflicted" | grep -q "^$sub$"; then
              conflicted_submodules="$conflicted_submodules $sub"
            fi
          done
          echo "Conflicted submodules:$conflicted_submodules"
          echo "submodules=$conflicted_submodules" >> $GITHUB_OUTPUT

      - name: Resolve conflicted submodules
        run: |
          for sub in ${{ steps.detect.outputs.submodules }}; do
            echo "Resolving submodule conflict: $sub"
            # Keep PR branch version ("ours") for the submodule
            git add "$sub"
          done
          if ! git diff --cached --quiet; then
            git commit --no-edit
          fi

      - name: Continue rebase
        run: |
          git rebase --continue || echo "⚠️ Rebase still has conflicts (non-submodule files)"

      - name: Force push rebased branch
        run: git push --force-with-lease origin ${{ github.event.inputs.pr_branch }}
