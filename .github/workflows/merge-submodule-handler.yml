name: Merge Submodule + Base PR (on /merge comment)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: write
  actions: write

env:
  # Filled in by the “Get submodule info” step – keep the placeholder for local testing.
  SUBMODULE_REPO: MOvenshire/submod
  CROSS_TOKEN: ${{ secrets.WORKFLOWS }}

jobs:
  merge-flow:
    if: |
      github.event.issue.pull_request != null &&
      github.event.comment.body == '/merge' &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest
    steps:

      # ------------------------------------------------------------------
      # 1️⃣ Checkout base repo (full history, **with** submodules)
      # ------------------------------------------------------------------
      - name: Checkout base repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
          token: ${{ env.CROSS_TOKEN }}

      # ------------------------------------------------------------------
      # 2️⃣ Detect submodule path / repo
      # ------------------------------------------------------------------
      - name: Get submodule info
        id: submod_info
        run: |
          # Grab the first submodule entry – adapt if you have many
          SUBMODULE_PATH=$(git config --file .gitmodules --get-regexp '^submodule\..*\.path$' | head -1 | awk '{print $2}')
          SUBMODULE_URL=$(git config --file .gitmodules --get-regexp '^submodule\..*\.url$' | head -1 | awk '{print $2}')

          # Convert URL → owner/repo (supports ssh & https)
          if [[ "$SUBMODULE_URL" == git@github.com:* ]]; then
            SUBMODULE_REPO=${SUBMODULE_URL#git@github.com:}
          elif [[ "$SUBMODULE_URL" == https://github.com/* ]]; then
            SUBMODULE_REPO=${SUBMODULE_URL#https://github.com/}
          else
            echo "❌ Unsupported submodule URL: $SUBMODULE_URL"
            exit 1
          fi
          SUBMODULE_REPO=${SUBMODULE_REPO%.git}

          echo "submodule_path=$SUBMODULE_PATH" >> $GITHUB_OUTPUT
          echo "submodule_repo=$SUBMODULE_REPO"   >> $GITHUB_OUTPUT
          echo "✅ Submodule detected: $SUBMODULE_REPO @ $SUBMODULE_PATH"

      # ------------------------------------------------------------------
      # 3️⃣ Gather PR metadata (head ref, head repo, base branch)
      # ------------------------------------------------------------------
      - name: Get base PR metadata
        id: pr_info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('pr_number', pr.number);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('base_ref', pr.base.ref);

      # ------------------------------------------------------------------
      # 4️⃣ **Find & merge the matching submodule PR** (must happen first)
      # ------------------------------------------------------------------
      - name: Find submodule PR
        id: find_submod_pr
        uses: actions/github-script@v7
        env:
          # The repo string comes from the previous step – we trim it just in case.
          SUBMODULE_REPO: ${{ steps.submod_info.outputs.submodule_repo }}
          GITHUB_TOKEN: ${{ env.CROSS_TOKEN }}   # <-- critical – use cross‑repo token
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            // --------------------------------------------------------------
            // 1️⃣ Split “owner/repo”. Trim whitespace that could have sneaked in.
            // --------------------------------------------------------------
            const rawRepo = process.env.SUBMODULE_REPO.trim();
            const [owner, repo] = rawRepo.split('/');
            core.info(`Looking for PRs in ${owner}/${repo}`);

            // --------------------------------------------------------------
            // 2️⃣ Branch name from the base PR (passed from the previous step)
            // --------------------------------------------------------------
            const headBranch = '${{ steps.pr_info.outputs.head_ref }}';
            core.info(`Base PR branch is ${headBranch}`);

            // --------------------------------------------------------------
            // 3️⃣ List **open** PRs in the submodule repository
            // --------------------------------------------------------------
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              per_page: 100          // avoid pagination for most setups
            });

            // --------------------------------------------------------------
            // 4️⃣ Find a PR whose head **branch** matches the base PR branch
            // --------------------------------------------------------------
            const match = prs.find(p => p.head.ref === headBranch);

            if (match) {
              core.setOutput('found', 'true');
              core.setOutput('pr_number', String(match.number));
              core.info(`✅ Matching submodule PR #${match.number} (branch ${headBranch})`);
            } else {
              core.setOutput('found', 'false');
              core.info('ℹ️ No matching submodule PR found for this branch');
            }

      # ------------------------------------------------------------------
      # 5️⃣ Merge submodule PR (if found)
      # ------------------------------------------------------------------
      - name: Merge submodule PR (if found)
        if: steps.find_submod_pr.outputs.found == 'true'
        id: merge_submodule
        uses: actions/github-script@v7
        env:
          SUBMODULE_REPO: ${{ steps.submod_info.outputs.submodule_repo }}
        with:
          github-token: ${{ env.CROSS_TOKEN }}   # must also use the cross‑repo token
          script: |
            const rawRepo = process.env.SUBMODULE_REPO.trim();
            const [owner, repo] = rawRepo.split('/');
            const number = parseInt('${{ steps.find_submod_pr.outputs.pr_number }}', 10);
            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: number,
              merge_method: 'merge'
            });
            core.info(`Merged submodule PR #${number}`);

      # ------------------------------------------------------------------
      # 6️⃣ Merge the base PR (admin‑style)
      # ------------------------------------------------------------------
      - name: Merge base PR
        id: merge_base
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const number = parseInt('${{ steps.pr_info.outputs.pr_number }}', 10);
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: number,
              merge_method: 'merge'
            });
            core.info(`Merged base PR #${number}`);
            core.setOutput('merged', 'true');

      # ------------------------------------------------------------------
      # 6️⃣ Bump submodule pointer – compare against *origin/main*
      # ------------------------------------------------------------------
      - name: Bump submodule pointer
        if: steps.merge_base.outputs.merged == 'true'   # runs after the base PR merge
        env:
          GITHUB_TOKEN_PUSH: ${{ env.CROSS_TOKEN }}
          SUBMODULE_PATH: ${{ steps.submod_info.outputs.submodule_path }}
          SUBMODULE_REPO: ${{ steps.submod_info.outputs.submodule_repo }}
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # --------------------------------------------------------------
          # Ensure we are on the latest `main` of the *parent* repo
          # --------------------------------------------------------------
          git checkout main
          git pull origin main

          # --------------------------------------------------------------
          # Create a temporary branch that we will push back to `main`
          # --------------------------------------------------------------
          BUMP_BRANCH="bump-submod-$(date +%s)"
          git switch -c "$BUMP_BRANCH"

          # --------------------------------------------------------------
          # 1️⃣ Make sure the submodule is present locally (init if needed)
          # --------------------------------------------------------------
          git submodule update --init --depth 1 "$SUBMODULE_PATH"

          # --------------------------------------------------------------
          # 2️⃣ Fetch *origin/main* of the submodule
          # --------------------------------------------------------------
          git -C "$SUBMODULE_PATH" fetch origin main

          # --------------------------------------------------------------
          # 3️⃣ Determine if the pointer already matches origin/main
          # --------------------------------------------------------------
          CURRENT_SHA=$(git -C "$SUBMODULE_PATH" rev-parse HEAD)
          ORIGIN_SHA=$(git -C "$SUBMODULE_PATH" rev-parse origin/main)

          if [[ "$CURRENT_SHA" == "$ORIGIN_SHA" ]]; then
            echo "Submodule already points to origin/main ($CURRENT_SHA) – nothing to push."
            exit 0
          fi

          # --------------------------------------------------------------
          # 4️⃣ Checkout the fetched commit (fast‑forward pointer)
          # --------------------------------------------------------------
          git -C "$SUBMODULE_PATH" checkout "$ORIGIN_SHA"

          # --------------------------------------------------------------
          # 5️⃣ Stage & commit the updated pointer
          # --------------------------------------------------------------
          git add "$SUBMODULE_PATH"
          git commit -m "chore(submod): bump $SUBMODULE_REPO to main $ORIGIN_SHA"

          # --------------------------------------------------------------
          # 6️⃣ Push fast‑forward (force‑with‑lease protects against races)
          # --------------------------------------------------------------
          git push "https://${GITHUB_TOKEN_PUSH}@github.com/${{ github.repository }}.git" \
            "$BUMP_BRANCH:main" --force-with-lease

      # ------------------------------------------------------------------
      # 7️⃣ Final comment – success / failure (now also reports submodule PR)
      # ------------------------------------------------------------------
      - name: Comment success
        if: steps.merge_base.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = context.payload.comment.id;
            const subFound = '${{ steps.find_submod_pr.outputs.found }}' === 'true';
            let body = "Pull Request Merged ✅\n\n";
            if (subFound) {
              body += `• Submodule PR #${{ steps.find_submod_pr.outputs.pr_number }} merged.\n`;
            } else {
              body += "• No matching submodule PR found.\n";
            }
            body += "• Base PR merged and submodule pointer bumped (if needed).\n";
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body
            });

      - name: Comment failure
        if: steps.merge_base.outcome != 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = context.payload.comment.id;
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: "Pull Request Not Merged ❌ – see workflow logs for details."
            });