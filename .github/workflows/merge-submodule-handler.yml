name: Merge Submodule + Base PR (on /merge comment)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: write
  actions: write

env:
  # Filled in by the ‚ÄúGet submodule info‚Äù step ‚Äì keep the placeholder for local testing.
  SUBMODULE_REPO: MOvenshire/submod
  CROSS_TOKEN: ${{ secrets.WORKFLOWS }}

jobs:
  merge-flow:
    if: |
      github.event.issue.pull_request != null &&
      github.event.comment.body == '/merge' &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest
    steps:

      # ------------------------------------------------------------------
      # 1Ô∏è‚É£ Checkout base repo (full history, **with** submodules)
      # ------------------------------------------------------------------
      - name: Checkout base repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
          token: ${{ env.CROSS_TOKEN }}

      # ------------------------------------------------------------------
      # 2Ô∏è‚É£ Detect submodule path / repo
      # ------------------------------------------------------------------
      - name: Get submodule info
        id: submod_info
        run: |
          # Grab the first submodule entry ‚Äì adapt if you have many
          SUBMODULE_PATH=$(git config --file .gitmodules --get-regexp '^submodule\..*\.path$' | head -1 | awk '{print $2}')
          SUBMODULE_URL=$(git config --file .gitmodules --get-regexp '^submodule\..*\.url$' | head -1 | awk '{print $2}')

          # Convert URL ‚Üí owner/repo (supports ssh & https)
          if [[ "$SUBMODULE_URL" == git@github.com:* ]]; then
            SUBMODULE_REPO=${SUBMODULE_URL#git@github.com:}
          elif [[ "$SUBMODULE_URL" == https://github.com/* ]]; then
            SUBMODULE_REPO=${SUBMODULE_URL#https://github.com/}
          else
            echo "‚ùå Unsupported submodule URL: $SUBMODULE_URL"
            exit 1
          fi
          SUBMODULE_REPO=${SUBMODULE_REPO%.git}

          echo "submodule_path=$SUBMODULE_PATH" >> $GITHUB_OUTPUT
          echo "submodule_repo=$SUBMODULE_REPO"   >> $GITHUB_OUTPUT
          echo "‚úÖ Submodule detected: $SUBMODULE_REPO @ $SUBMODULE_PATH"

      # ------------------------------------------------------------------
      # 3Ô∏è‚É£ Gather PR metadata (head ref, head repo, base branch)
      # ------------------------------------------------------------------
      - name: Get base PR metadata
        id: pr_info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('pr_number', pr.number);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_repo', pr.head.repo.full_name);
            core.setOutput('base_ref', pr.base.ref);

      # ------------------------------------------------------------------
      # 4Ô∏è‚É£ **Find & merge the matching submodule PR** (must happen first)
      # ------------------------------------------------------------------
      - name: Find submodule PR
        id: find_submod_pr
        uses: actions/github-script@v7
        env:
          # The repo string comes from the previous step ‚Äì we trim it just in case.
          SUBMODULE_REPO: ${{ steps.submod_info.outputs.submodule_repo }}
          GITHUB_TOKEN: ${{ env.CROSS_TOKEN }}   # <-- critical ‚Äì use cross‚Äërepo token
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            // --------------------------------------------------------------
            // 1Ô∏è‚É£ Split ‚Äúowner/repo‚Äù. Trim whitespace that could have sneaked in.
            // --------------------------------------------------------------
            const rawRepo = process.env.SUBMODULE_REPO.trim();
            const [owner, repo] = rawRepo.split('/');
            core.info(`Looking for PRs in ${owner}/${repo}`);

            // --------------------------------------------------------------
            // 2Ô∏è‚É£ Branch name from the base PR (passed from the previous step)
            // --------------------------------------------------------------
            const headBranch = '${{ steps.pr_info.outputs.head_ref }}';
            core.info(`Base PR branch is ${headBranch}`);

            // --------------------------------------------------------------
            // 3Ô∏è‚É£ List **open** PRs in the submodule repository
            // --------------------------------------------------------------
            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              per_page: 100          // avoid pagination for most setups
            });

            // --------------------------------------------------------------
            // 4Ô∏è‚É£ Find a PR whose head **branch** matches the base PR branch
            // --------------------------------------------------------------
            const match = prs.find(p => p.head.ref === headBranch);

            if (match) {
              core.setOutput('found', 'true');
              core.setOutput('pr_number', String(match.number));
              core.info(`‚úÖ Matching submodule PR #${match.number} (branch ${headBranch})`);
            } else {
              core.setOutput('found', 'false');
              core.info('‚ÑπÔ∏è No matching submodule PR found for this branch');
            }

      # ------------------------------------------------------------------
      # 5Ô∏è‚É£ Merge submodule PR (if found)
      # ------------------------------------------------------------------
      - name: Merge submodule PR (if found)
        if: steps.find_submod_pr.outputs.found == 'true'
        id: merge_submodule
        uses: actions/github-script@v7
        env:
          SUBMODULE_REPO: ${{ steps.submod_info.outputs.submodule_repo }}
        with:
          github-token: ${{ env.CROSS_TOKEN }}   # must also use the cross‚Äërepo token
          script: |
            const rawRepo = process.env.SUBMODULE_REPO.trim();
            const [owner, repo] = rawRepo.split('/');
            const number = parseInt('${{ steps.find_submod_pr.outputs.pr_number }}', 10);
            await github.rest.pulls.merge({
              owner,
              repo,
              pull_number: number,
              merge_method: 'squash'
              commit_title: `chore(submod): squash merge #${number}`,
              commit_message: `Squash‚Äëmerged submodule PR #${number}`
            });
            core.info(`Merged submodule PR #${number}`);
            core.setOutput('merged', 'true');

      # ------------------------------------------------------------------
      # 6Ô∏è‚É£ Bump submodule pointer ‚Äì compare against *origin/main*
      # ------------------------------------------------------------------
      - name: Bump submodule pointer
        if: steps.merge_submodule.outputs.merged == 'true'
        env:
          GITHUB_TOKEN_PUSH: ${{ env.CROSS_TOKEN }}
          SUBMODULE_PATH: ${{ steps.submod_info.outputs.submodule_path }}
          SUBMODULE_REPO: ${{ steps.submod_info.outputs.submodule_repo }}
          PR_HEAD_REF: ${{ steps.pr_info.outputs.head_ref }}   # ‚Üê PR source branch
          BASE_REF: ${{ steps.pr_info.outputs.base_ref }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          echo "üîß Environment:"
          echo "  PR_HEAD_REF=$PR_HEAD_REF"

          # --------------------------------------------------------------
          # Ensure we have the latest PR head locally
          # --------------------------------------------------------------
          git fetch origin "$PR_HEAD_REF"
          git checkout -B "$PR_HEAD_REF" "origin/$PR_HEAD_REF"

          # --------------------------------------------------------------
          # Initialise (or update) the submodule and fetch its main branch
          # --------------------------------------------------------------
          git submodule update --init --depth 1 "$SUBMODULE_PATH"
          git -C "$SUBMODULE_PATH" fetch origin main

          # --------------------------------------------------------------
          # Compare current pointer with submodule's origin/main
          # --------------------------------------------------------------
          CURRENT_SHA=$(git -C "$SUBMODULE_PATH" rev-parse HEAD)
          ORIGIN_SHA=$(git -C "$SUBMODULE_PATH" rev-parse origin/main)
          echo "üîé Current submodule SHA: $CURRENT_SHA"
          echo "üîé Origin/main SHA:       $ORIGIN_SHA"

          if [[ "$CURRENT_SHA" == "$ORIGIN_SHA" ]]; then
            echo "‚úÖ Submodule already points to origin/main ($CURRENT_SHA). No action needed."
            exit 0
          fi

          # --------------------------------------------------------------
          # Fast‚Äëforward the submodule to the latest main commit
          # --------------------------------------------------------------
          echo "üöÄ Fast‚Äëforwarding submodule to $ORIGIN_SHA..."
          git -C "$SUBMODULE_PATH" checkout "$ORIGIN_SHA"

          # --------------------------------------------------------------
          # Commit the updated pointer in the parent repo
          # --------------------------------------------------------------
          echo "üìù Configuring git user..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "üìÇ Staging submodule changes..."
          git add "$SUBMODULE_PATH"
          echo "üíæ Creating commit..."
          git commit -m "chore(submod): bump $SUBMODULE_REPO to main $ORIGIN_SHA"

          
          echo "üì§ Pushing changes back to PR branch..."
          git push "https://${GITHUB_TOKEN_PUSH}@github.com/${{ github.repository }}.git" \
            "$PR_HEAD_REF" --force
            
          git fetch origin "$PR_HEAD_REF" "$BASE_REF"
          # Ensure we are on the PR branch (the checkout step earlier left us there)
          git checkout "$PR_HEAD_REF"
          # Update the local base ref to match origin
          git update-ref refs/remotes/origin/"$BASE_REF" "origin/$BASE_REF"

      # ------------------------------------------------------------------
      # 6Ô∏è‚É£ Merge the base PR 
      # ------------------------------------------------------------------
      - name: Merge base PR
        id: merge_base
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const number = parseInt('${{ steps.pr_info.outputs.pr_number }}', 10);
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: number,
              merge_method: 'squash',
              commit_title: `chore(submod): squash merge #${number}`,
              commit_message: `Squash‚Äëmerged submodule PR #${number}`
            });
            core.info(`Merged base PR #${number}`);
            core.setOutput('merged', 'true');

      # ------------------------------------------------------------------
      # 7Ô∏è‚É£ Final comment ‚Äì success / failure (now also reports submodule PR)
      # ------------------------------------------------------------------
      - name: Comment success
        if: steps.merge_base.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = context.payload.comment.id;
            const subFound = '${{ steps.find_submod_pr.outputs.found }}' === 'true';
            let body = "Pull Request Merged ‚úÖ\n\n";
            if (subFound) {
              body += `‚Ä¢ Submodule PR #${{ steps.find_submod_pr.outputs.pr_number }} merged.\n`;
            } else {
              body += "‚Ä¢ No matching submodule PR found.\n";
            }
            body += "‚Ä¢ Base PR merged and submodule pointer bumped (if needed).\n";
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body
            });

      - name: Comment failure
        if: steps.merge_base.outcome != 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = context.payload.comment.id;
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: "Pull Request Not Merged ‚ùå ‚Äì see workflow logs for details."
            });