      # ------------------------------------------------------------------
      # 2Ô∏è‚É£ Detect ALL submodules
      # ------------------------------------------------------------------
      - name: Get submodule info
        id: submods
        run: |
          SUBMODULES_JSON="[]"
          while IFS= read -r entry; do
            SUBMODULE_PATH=$(echo "$entry" | awk '{print $2}')
            SUBMODULE_URL=$(git config --file .gitmodules --get "submodule.${SUBMODULE_PATH}.url")

            # Convert URL ‚Üí owner/repo
            if [[ "$SUBMODULE_URL" == git@github.com:* ]]; then
              SUBMODULE_REPO=${SUBMODULE_URL#git@github.com:}
            elif [[ "$SUBMODULE_URL" == https://github.com/* ]]; then
              SUBMODULE_REPO=${SUBMODULE_URL#https://github.com/}
            else
              echo "‚ùå Unsupported submodule URL: $SUBMODULE_URL"
              exit 1
            fi
            SUBMODULE_REPO=${SUBMODULE_REPO%.git}

            # Append to JSON
            SUBMODULES_JSON=$(jq -c \
              --arg path "$SUBMODULE_PATH" \
              --arg repo "$SUBMODULE_REPO" \
              '. += [{"path": $path, "repo": $repo}]' <<< "$SUBMODULES_JSON")
          done < <(git config --file .gitmodules --get-regexp '^submodule\..*\.path$')

          echo "submodules=$SUBMODULES_JSON" >> $GITHUB_OUTPUT
          echo "‚úÖ Found submodules: $SUBMODULES_JSON"

      # ------------------------------------------------------------------
      # 4Ô∏è‚É£-6Ô∏è‚É£ Process each submodule sequentially
      # ------------------------------------------------------------------
      - name: Process submodules
        id: process_submods
        env:
          CROSS_TOKEN: ${{ env.CROSS_TOKEN }}
          SUBMODULES: ${{ steps.submods.outputs.submodules }}
          HEAD_REF: ${{ steps.pr_info.outputs.head_ref }}
          BASE_REF: ${{ steps.pr_info.outputs.base_ref }}
          REPO: ${{ github.repository }}
        run: |
          set -euo pipefail
          RESULTS=""

          for row in $(echo "$SUBMODULES" | jq -c '.[]'); do
            SUB_PATH=$(echo "$row" | jq -r '.path')
            SUB_REPO=$(echo "$row" | jq -r '.repo')
            echo "üîé Processing submodule $SUB_REPO ($SUB_PATH)"

            # Find matching PR
            PR_NUM=$(gh api repos/$SUB_REPO/pulls \
              -H "Authorization: Bearer $CROSS_TOKEN" \
              --jq ".[] | select(.head.ref==\"$HEAD_REF\") | .number" || true)

            if [[ -n "$PR_NUM" ]]; then
              echo "‚úÖ Found submodule PR #$PR_NUM"
              # Merge PR
              gh api repos/$SUB_REPO/pulls/$PR_NUM/merge \
                -H "Authorization: Bearer $CROSS_TOKEN" \
                -f merge_method=squash || { RESULTS="$RESULTS\n‚Ä¢ $SUB_REPO: merge failed ‚ùå"; exit 1; }
              echo "‚úÖ Merged submodule PR #$PR_NUM"

              # Bump pointer
              git fetch origin "$HEAD_REF"
              git checkout -B "$HEAD_REF" "origin/$HEAD_REF"
              git submodule update --init "$SUB_PATH"
              git -C "$SUB_PATH" fetch origin main
              git -C "$SUB_PATH" checkout origin/main
              git add "$SUB_PATH"
              git config user.name "github-actions[bot]"
              git config user.email "github-actions[bot]@users.noreply.github.com"
              git commit -m "chore(submod): bump $SUB_REPO to origin/main" || true
              git push "https://${CROSS_TOKEN}@github.com/$REPO.git" "$HEAD_REF" --force
              RESULTS="$RESULTS\n‚Ä¢ $SUB_REPO: merged #$PR_NUM + bumped ‚úÖ"
            else
              RESULTS="$RESULTS\n‚Ä¢ $SUB_REPO: no matching PR found ‚ÑπÔ∏è"
            fi
          done

          echo "results=$RESULTS" >> $GITHUB_OUTPUT

      # ------------------------------------------------------------------
      # 6Ô∏è‚É£ Merge base PR (only if all submodules succeeded)
      # ------------------------------------------------------------------
      - name: Merge base PR
        if: success()
        id: merge_base
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const number = parseInt('${{ steps.pr_info.outputs.pr_number }}', 10);
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: number,
              merge_method: 'squash',
              commit_title: `chore(submods): squash merge #${number}`,
              commit_message: `Squash-merged base PR after submodule merges.`,
            });

      # ------------------------------------------------------------------
      # 7Ô∏è‚É£ Final comment
      # ------------------------------------------------------------------
      - name: Comment success
        if: steps.merge_base.outcome == 'success'
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = context.payload.comment.id;
            const results = `\n${{ steps.process_submods.outputs.results }}`;
            await github.rest.issues.updateComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              comment_id: commentId,
              body: "Pull Request Merged ‚úÖ\n" + results,
            })
