name: Submodule Conflict Resolver

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  resolve-submodule-conflicts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository shallowly with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.WORKFLOWS }}
          fetch-depth: 1  # shallow fetch to minimize data
          
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine submodules
        id: submodules
        run: |
          mapfile -t SUBMODULES < <(git config --file .gitmodules --get-regexp path | awk '{print $2}')
          echo "SUBMODULES=${SUBMODULES[*]}" >> $GITHUB_ENV

      - name: Configure submodule authentication
        run: |
          for sub in $SUBMODULES; do
            URL=$(git config --file .gitmodules submodule.$sub.url)
            AUTH_URL=${URL/https:\/\/github.com\//https:\/\/${GITHUB_ACTOR}:${{ secrets.WORKFLOWS }}@github.com/}
            git config submodule.$sub.url $AUTH_URL
          done

      - name: Reset all submodules to base and reapply original SHAs
        run: |
          BASE_BRANCH=main

          # Fetch enough history for the base branch
          git fetch origin $BASE_BRANCH:refs/remotes/origin/$BASE_BRANCH --depth=50

          # Save original SHAs
          declare -A ORIG_SHAS
          for sub in $SUBMODULES; do
            ORIG_SHAS[$sub]=$(git rev-parse HEAD:$sub)
          done

          # Determine base commit
          BASE_COMMIT=$(git merge-base HEAD origin/$BASE_BRANCH)

          # Reset submodules to base
          git checkout $BASE_COMMIT -- "${SUBMODULES[@]}"
          git add "${SUBMODULES[@]}"
          if ! git diff --cached --quiet; then
            git commit -m "Reset all submodules to base branch ($BASE_BRANCH)"
          fi

          # Reapply original SHAs
          for sub in "${SUBMODULES[@]}"; do
            git checkout ${ORIG_SHAS[$sub]} -- $sub
          done
          git add "${SUBMODULES[@]}"
          if ! git diff --cached --quiet; then
            git commit -m "Reapply original submodule SHAs"
          fi

          # Push once
          git push origin HEAD
