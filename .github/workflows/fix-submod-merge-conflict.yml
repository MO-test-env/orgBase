name: Submodule Conflict Resolver

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  resolve-submodule-conflicts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository shallowly with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.WORKFLOWS }}
          fetch-depth: 1  # shallow fetch to minimize data
          
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine submodules
        id: submodules
        run: |
          mapfile -t SUBMODULES < <(git config --file .gitmodules --get-regexp path | awk '{print $2}')
          echo "SUBMODULES=${SUBMODULES[*]}" >> $GITHUB_ENV

      - name: Configure submodule authentication
        run: |
          for sub in $SUBMODULES; do
            URL=$(git config --file .gitmodules submodule.$sub.url)
            AUTH_URL=${URL/https:\/\/github.com\//https:\/\/${GITHUB_ACTOR}:${{ secrets.WORKFLOWS }}@github.com/}
            git config submodule.$sub.url $AUTH_URL
          done

      - name: Reset submodules to base and reapply original SHAs safely
        run: |
          BASE_BRANCH=main
          git fetch origin $BASE_BRANCH --depth=50
          BASE_COMMIT=$(git merge-base HEAD origin/$BASE_BRANCH)

          declare -A ORIG_SHAS
          for sub in $SUBMODULES; do
            ORIG_SHAS[$sub]=$(git rev-parse HEAD:$sub)
          done

          # Reset all submodules to base branch
          git checkout $BASE_COMMIT -- "${SUBMODULES[@]}"
          git add "${SUBMODULES[@]}"
          if ! git diff --cached --quiet; then
            git commit -m "Reset all submodules to base branch ($BASE_BRANCH)"
          fi

          # Reapply original SHAs safely
          for sub in "${SUBMODULES[@]}"; do
            git -C $sub fetch origin ${ORIG_SHAS[$sub]} --depth=1
            git -C $sub checkout ${ORIG_SHAS[$sub]}
          done
          git add "${SUBMODULES[@]}"

          if ! git diff --cached --quiet; then
            git commit -m "Reapply original submodule SHAs"
          fi

          git push origin HEAD
