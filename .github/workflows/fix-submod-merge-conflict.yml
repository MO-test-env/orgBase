name: Submodule Conflict Resolver (Private Repos)

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  resolve-submodule-conflicts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout the repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.WORKFLOWS }}
          fetch-depth: 0  # fetch full history to allow rebases

      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine submodules
        id: submodules
        run: |
          git config --file .gitmodules --get-regexp path | awk '{print $2}' > submodules.txt
          echo "SUBMODULES=$(cat submodules.txt | tr '\n' ' ')" >> $GITHUB_ENV

      - name: Configure submodule authentication
        run: |
          for sub in $SUBMODULES; do
            URL=$(git config --file .gitmodules submodule.$sub.url)
            AUTH_URL=${URL/https:\/\/github.com\//https:\/\/${GITHUB_ACTOR}:${{ secrets.WORKFLOWS }}@github.com/}
            git config submodule.$sub.url $AUTH_URL
          done
      
      # Save original submodule SHAs 
      - name: Save original submodule SHAs
        id: save-shas
        run: |
          declare -A ORIG_SHAS
          for sub in $SUBMODULES; do
            ORIG_SHAS[$sub]=$(git rev-parse HEAD:$sub)
            echo "$sub=${ORIG_SHAS[$sub]}" >> shas.txt
          done
          echo "ORIG_SHAS_FILE=shas.txt" >> $GITHUB_ENV

      - name: Update submodules to latest
        run: |
          for sub in $SUBMODULES; do
            echo "Updating $sub..."
            git submodule update --init --remote $sub
          done

      - name: Resolve submodule conflicts
        run: |
          for sub in $SUBMODULES; do
            echo "Resetting submodule $sub to base branch..."
            BASE_BRANCH=main  # adjust if your default branch is different
            git fetch origin $BASE_BRANCH
            BASE_COMMIT=$(git merge-base HEAD origin/$BASE_BRANCH)
            git checkout $BASE_COMMIT -- $sub
            git add $sub
          done

      - name: Commit resolved submodules
        run: |
          if ! git diff --cached --quiet; then
            git commit -m "Automated submodule conflict resolution (private repos)"
            git push origin HEAD
          else
            echo "No submodule conflicts to resolve."
          fi
      
      # Reset submodules to their original SHAs
      - name: Reset submodules to original SHAs
        run: |
          echo "Resetting submodules to their original SHAs..."
          while IFS='=' read -r sub sha; do
            echo "Resetting $sub to $sha"
            git checkout $sha -- $sub
            git add $sub
          done < $ORIG_SHAS_FILE

      - name: Commit submodules back to original SHAs
        run: |
          if ! git diff --cached --quiet; then
            git commit -m "Reset submodules to original SHAs"
            git push origin HEAD
          else
            echo "Submodules already at original SHAs."
          fi
      - name: Commit resolved submodules
        run: |
          if ! git diff --cached --quiet; then
            git commit -m "Automated submodule conflict resolution (private repos)"
            git push origin HEAD
          else
            echo "No submodule conflicts to resolve."
          fi