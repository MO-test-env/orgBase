name: Rebase Base Branch & Submodules 

on:
  workflow_dispatch:
    inputs:
      base_branch:
        description: 'Branch to rebase onto'
        default: 'main'
        required: true

permissions:
  contents: write
  pull-requests: write

env:
  RW_PAT: ${{ secrets.WORKFLOWS }} # PAT with 'repo' access to private repos

jobs:
  rebase:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    steps:
      - name: Checkout repository with private submodules
        uses: actions/checkout@v4
        with:
          token: ${{ env.RW_PAT }}
          submodules: recursive
          fetch-depth: 0

      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Rebase main branch
        run: |
          BASE_BRANCH="${{ github.event.inputs.base_branch }}"
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "Rebasing $CURRENT_BRANCH onto $BASE_BRANCH"
          git fetch origin "$BASE_BRANCH"
          git checkout "$CURRENT_BRANCH"
          if ! git rebase "origin/$BASE_BRANCH"; then
            echo "::error::Merge conflicts detected in main repo. Resolve manually."
            exit 1
          fi

      - name: Rebase Submodules
        run: |
          SUBMODULES=$(git config --file .gitmodules --get-regexp path | awk '{print $2}')
          for sub in $SUBMODULES; do
            echo "Rebasing submodule: $sub"
            pushd "$sub" > /dev/null
            # Ensure authentication for private submodule
            git remote set-url origin https://x-access-token:${RW_PAT}@github.com/$(git remote get-url origin | sed -E 's/.*github.com\/(.*)/\1/')
            SUB_BRANCH=$(git rev-parse --abbrev-ref HEAD)
            git fetch origin
            if ! git rebase "origin/$SUB_BRANCH"; then
              echo "::error::Merge conflicts detected in submodule $sub. Resolve manually."
              exit 1
            fi
            popd > /dev/null
          done

      - name: Push changes if no conflicts
        run: |
          if [ -z "$(git status --porcelain)" ]; then
            echo "No changes to push"
          else
            echo "Pushing rebased branches"
            git push origin HEAD --force
            git submodule foreach --recursive 'git push origin HEAD --force'
