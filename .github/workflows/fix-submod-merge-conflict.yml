name: Auto-resolve submodule pointer conflicts

on:
  workflow_dispatch:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write

jobs:
  resolve-submodules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup git user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch base branch
        run: |
          git fetch origin ${{ github.base_ref }} --depth=1

      - name: Attempt merge of base into PR
        run: |
          git merge --no-edit origin/${{ github.base_ref }} || true

      - name: Auto-resolve submodule conflicts as ours
        run: |
          mapfile -t SUBS < <(git config --file .gitmodules --get-regexp path | awk '{print $2}')
          for sub in "${SUBS[@]}"; do
            if git ls-files --unmerged "$sub" >/dev/null 2>&1; then
              echo "Resolving submodule $sub as ours"
              ours_sha=$(git rev-parse HEAD:"$sub")
              git update-index --cacheinfo 160000 $ours_sha "$sub"
              git add "$sub"
            fi
          done

      - name: Commit and push if needed
        run: |
          if ! git diff --cached --quiet; then
            git commit -m "ci: auto-resolve submodule pointer conflicts (ours)"
            git push origin HEAD:${{ github.head_ref }}
          else
            echo "No submodule pointer conflicts to fix."
          fi
