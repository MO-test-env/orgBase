name: Submodule Conflict Resolver

on:
  workflow_dispatch:

permissions:
  contents: write

jobs:
  resolve-submodule-conflicts:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository shallowly with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          token: ${{ secrets.WORKFLOWS }}
          fetch-depth: 1  # shallow fetch to minimize data
          
      - name: Setup Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine submodules
        id: submodules
        run: |
          mapfile -t SUBMODULES < <(git config --file .gitmodules --get-regexp path | awk '{print $2}')
          echo "SUBMODULES=${SUBMODULES[*]}" >> $GITHUB_ENV

      - name: Configure submodule authentication
        run: |
          for sub in $SUBMODULES; do
            URL=$(git config --file .gitmodules submodule.$sub.url)
            AUTH_URL=${URL/https:\/\/github.com\//https:\/\/${GITHUB_ACTOR}:${{ secrets.WORKFLOWS }}@github.com/}
            git config submodule.$sub.url $AUTH_URL
          done

      - name: Update submodules safely
        run: |
          for sub in $SUBMODULES; do
            echo "Processing submodule $sub..."
            
            # Get the original SHA of this submodule
            ORIG_SHA=$(git rev-parse HEAD:$sub)
            
            # Go into the submodule directory
            cd $sub
            
            # Fetch only the exact SHA needed
            git fetch origin $ORIG_SHA --depth=1
            
            # Checkout that SHA explicitly
            git checkout $ORIG_SHA
            
            # Go back to main repo
            cd -
          done
      
      - name: Update submodules to latest
        run: |
          for sub in $SUBMODULES; do
            echo "Updating $sub..."
            git submodule update --init --remote $sub
          done
      
      - name: Reset submodules to base and reapply original SHAs safely
        run: |
          set -euo pipefail
          set -x  # Bash debug mode

          BASE_BRANCH=main
          echo "Fetching base branch '$BASE_BRANCH' with depth 50..."
          git fetch origin $BASE_BRANCH --depth=50

          BASE_COMMIT=$(git merge-base HEAD origin/$BASE_BRANCH)
          echo "Computed merge base commit: $BASE_COMMIT"

          echo "Submodules to process: ${SUBMODULES[@]}"

          # Save original SHAs
          declare -A ORIG_SHAS
          for sub in "${SUBMODULES[@]}"; do
            ORIG_SHAS[$sub]=$(git rev-parse HEAD:$sub)
            echo "Saved original SHA for submodule '$sub': ${ORIG_SHAS[$sub]}"
          done

          echo "Step 1: Reset all submodules to base branch"
          git checkout $BASE_COMMIT -- "${SUBMODULES[@]}"
          git add "${SUBMODULES[@]}"

          if ! git diff --cached --quiet; then
            echo "Changes detected after resetting submodules. Committing..."
            git commit -m "Reset all submodules to base branch ($BASE_BRANCH)"
          else
            echo "No changes detected after resetting submodules."
          fi

          echo "Step 2: Reapply original SHAs safely"
          for sub in "${SUBMODULES[@]}"; do
            echo "Fetching original SHA ${ORIG_SHAS[$sub]} for submodule '$sub'..."
            git -C "$sub" fetch origin ${ORIG_SHAS[$sub]} --depth=1 || echo "Warning: fetch failed for $sub"
            echo "Checking out original SHA ${ORIG_SHAS[$sub]} in submodule '$sub'..."
            git -C "$sub" checkout ${ORIG_SHAS[$sub]} || echo "Warning: checkout failed for $sub"
          done

          git add "${SUBMODULES[@]}"
          if ! git diff --cached --quiet; then
            echo "Changes detected after reapplying SHAs. Committing..."
            git commit -m "Reapply original submodule SHAs"
          else
            echo "No changes detected after reapplying SHAs."
          fi

          echo "Final step: push changes to origin"
          git push origin HEAD
          echo "Push complete."
