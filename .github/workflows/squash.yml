name: Squash

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR Number"
        required: true
        type: number
        default: 78

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  RW_PAT: ${{ secrets.GITHUB_TOKEN }}

jobs:
  squash-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Squash commits
        id: squash
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const prNumber = parseInt("${{ inputs.pr_number }}");
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            // Get the PR details
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });

            // Get PR commits
            const { data: commits } = await github.rest.pulls.listCommits({
              owner,
              repo,
              pull_number: prNumber
            });

            core.info(`Found ${commits.length} commits in PR #${prNumber}`);

            if (commits.length <= 1) {
              core.setOutput("squash_needed", "false");
              core.info("No need to squash - PR has only one commit");
              return;
            }

            const squashCommitMessage = `${pr.data.title} \n\n ${pr.data.body || ''}\n\nSquashed commits: ${commits.length}`;

            try {
              // Get the PR base commit SHA
              const baseSha = pr.data.base.sha;

              // Fetch that commit so we can get its parent
              const { data: baseCommit } = await github.rest.git.getCommit({
                owner,
                repo,
                commit_sha: baseSha
              });

              if (!baseCommit.parents || baseCommit.parents.length === 0) {
                throw new Error("Base commit has no parent; cannot determine prior commit.");
              }

              // Use the parent of the base commit
              const parentBeforeBaseSha = baseCommit.parents[0].sha;
              core.info(`Using commit before base: ${parentBeforeBaseSha}`);

              // Head commit is still the last PR commit
              const headCommitSha = commits[commits.length - 1].sha;

              const { data: headCommit } = await github.rest.git.getCommit({
                owner,
                repo,
                commit_sha: headCommitSha
              });

              // Create the new squash commit using prior-to-base as the parent
              const { data: newCommit } = await github.rest.git.createCommit({
                owner,
                repo,
                message: squashCommitMessage,
                tree: headCommit.tree.sha,
                parents: [parentBeforeBaseSha]
              });

              // Update the PR branch to point to the squash commit
              const branchRef = pr.data.head.ref;
              await github.rest.git.updateRef({
                owner,
                repo,
                ref: `heads/${branchRef}`,
                sha: newCommit.sha,
                force: true
              });

              core.info(`Successfully squashed commits into new commit ${newCommit.sha}`);
              core.setOutput("squash_result", "success");

            } catch (error) {
              core.setFailed(`Failed to squash commits: ${error.message}`);
              core.setOutput("squash_result", "failed");
            }
