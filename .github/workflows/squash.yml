name: Squash

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: 'PR Number'
        required: true
        type: number

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  RW_PAT: ${{ secrets.GITHUB_TOKEN }}

jobs:
  squash-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Check PR commits
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = parseInt(core.getInput("pr_number"));

            const commits = await github.rest.pulls.listCommits({
              owner,
              repo,
              pull_number: prNumber,
            });

            if (commits.data.length <= 1) {
              core.setOutput("squash_result", "skipped");
            } else {
              core.setOutput("squash_result", "proceed");
            }

      - name: Squash commits (API only)
        if: steps.check.outputs.squash == 'proceed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const prNumber = parseInt(core.getInput("pr_number"));

            // Get PR info
            const pr = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });

            const headSha = pr.data.head.sha;

            // Get all commits for message aggregation
            const commits = await github.rest.pulls.listCommits({
              owner,
              repo,
              pull_number: prNumber,
            });

            const squashMessage =
              `Squash ${commits.data.length} commits\n\n` +
              commits.data.map(c => `- ${c.commit.message}`).join("\n");

            // Retrieve the HEAD commit’s tree
            const headCommit = await github.rest.git.getCommit({
              owner,
              repo,
              commit_sha: headSha,
            });

            const treeSha = headCommit.data.tree.sha;


            // Create a new commit with:
            //     - HEAD's tree
            //     - A single combined commit message
            const newCommit = await github.rest.git.createCommit({
              owner,
              repo,
              message: squashMessage,
              tree: treeSha,
              parents: [headSha],   // ⚠️ must use HEAD, not base
            });

            // Force update PR branch reference to point to the new commit
            await github.rest.git.updateRef({
              owner,
              repo,
              ref: `heads/${headRef}`,
              sha: newCommit.data.sha,
              force: true,
            });

            core.setOutput("squash_result", "success");
