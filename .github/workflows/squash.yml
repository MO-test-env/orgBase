name: Squash

on:
  workflow_call:
    inputs:
      username:
        description: 'User that triggered the workflow'
        required: true
        type: string
      owner:
        description: 'Organization'
        required: true
        type: string
      repo:
        description: 'Repository'
        required: true
        type: string
      pr_number:
        description: 'PR Number'
        required: true
        type: number
      comment_id:
        description: 'Comment ID'
        required: true
        type: number
    secrets:
      token:
        description: 'Personal Access Token with RW access to repo contents, PRs'
        required: true

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  RW_PAT: ${{ secrets.token }}
  USERNAME: ${{ inputs.username }}
  OWNER: ${{ inputs.owner }}
  REPO: ${{ inputs.repo }}
  PR_NUMBER: ${{ inputs.pr_number }}
  COMMENT_ID: ${{ inputs.comment_id }}

concurrency:
  group: squash-operations-${{ inputs.owner }}-${{ inputs.repo }}
  cancel-in-progress: false

jobs:
  squash-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Comment start
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const commentId = process.env.COMMENT_ID;
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const { data: comment } = await github.rest.issues.getComment({
              owner,
              repo,
              comment_id: commentId,
            });
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            let appendMsg = "\n # üóúÔ∏è Squash workflow started #\n";
            appendMsg = appendMsg + `[üñ•Ô∏è View this workflow run](${runUrl})`;
            appendMsg = appendMsg + "\n**_(Step 1/3)_** Initializing \n - Checking user permissions.";
            const newBody = comment.body + appendMsg;
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: commentId,
              body: newBody,
            });

      - name: Squash commits
        id: squash
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const prNumber = process.env.PR_NUMBER;
            
            try {
              // Get the PR details
              const pr = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber,
              });
              
              // Get commits for this PR
              const commitsResponse = await github.rest.pulls.listCommits({
                owner,
                repo,
                pull_number: prNumber,
              });
              
              const commits = commitsResponse.data;
              const headRef = pr.data.head.ref;
              const baseRef = pr.data.base.ref;
              const prTitle = pr.data.title;
              
              // Skip if there's only one commit
              if (commits.length <= 1) {
                core.info(`PR has only ${commits.length} commit(s), skipping squash`);
                core.setOutput("squash_result", "skipped");
                return;
              }
              
              // Get all commit messages
              const { execSync } = require('child_process');
              const run = (cmd, options = {}) => {
                console.log(`$ ${cmd}`);
                return execSync(cmd, { stdio: 'pipe', encoding: 'utf8', ...options }).trim();
              };
              
              // Fetch latest base and head
              run(`git fetch origin ${baseRef}:refs/remotes/origin/${baseRef}`);
              run(`git fetch origin ${headRef}:refs/remotes/origin/${headRef}`);
              run(`git checkout ${headRef}`);
              
              // Find common base commit
              const base = run(`git merge-base HEAD origin/${baseRef}`);
              
              // Get all commit messages
              const msgs = run(`git log --reverse --pretty=format:"%s%n%b" ${base}..HEAD`);
              const subject = `${prTitle} - Squash`;
              
              // Reset to base and create new commit
              run(`git reset --soft ${base}`);
              run(`git commit -m "${subject}" -m "${msgs.replace(/"/g, '\\"')}"`);
              
              // Push changes back to PR branch
              run(`git push --force-with-lease origin ${headRef}`);
              
              core.info(`Successfully squashed ${commits.length} commits into a single commit`);
              core.setOutput("squash_result", "success");
            } catch (error) {
              core.setFailed(`Failed to squash commits: ${error.message}`);
              core.setOutput("squash_result", "failed");
            }
            
      - name: Comment result
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const commentId = process.env.COMMENT_ID;
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const { data: comment } = await github.rest.issues.getComment({
              owner,
              repo,
              comment_id: commentId,
            });
            
            // Get the squash result from the previous step
            const squashResult = process.env.SQUASH_RESULT || "success";
            let appendMsg = "";
            
            if (squashResult === "success") {
              appendMsg = "\n - Commits squashed successfully!";
            } else if (squashResult === "skipped") {
              appendMsg = "\n - PR has only one commit, skipping squash.";
            } else {
              appendMsg = "\n - Failed to squash commits. Please check the workflow logs.";
            }
            
            const newBody = comment.body + appendMsg;
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: commentId,
              body: newBody,
            });