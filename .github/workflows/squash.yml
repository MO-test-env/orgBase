name: Squash

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR Number"
        required: true
        type: number
        default: 78

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  RW_PAT: ${{ secrets.GITHUB_TOKEN }}

jobs:
  squash-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Check PR commits
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const prNumber = parseInt("${{ inputs.pr_number }}");
            const { owner, repo } = context.repo;

            const commits = await github.rest.pulls.listCommits({
              owner,
              repo,
              pull_number: prNumber,
            });

            core.setOutput(
              "squash_result",
              commits.data.length > 1 ? "proceed" : "skipped"
            );

      - name: Squash commits (API only)
        if: steps.check.outputs.squash_result == 'proceed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const prNumber = parseInt("${{ inputs.pr_number }}");

            // Load PR
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            // Use the *actual* repo that holds the PR branch
            const headOwner = pr.data.head.repo.owner.login;
            const headRepo  = pr.data.head.repo.name;
            const branch    = pr.data.head.ref;
            const headSha   = pr.data.head.sha;

            // Get commits
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const squashMessage =
              `Squash ${commits.data.length} commits\n\n` +
              commits.data.map(c => `- ${c.commit.message}`).join('\n');

            // Get HEAD commit (for tree SHA)
            const headCommit = await github.rest.git.getCommit({
              owner: headOwner,
              repo: headRepo,
              commit_sha: headSha,
            });

            // Create new commit with same tree and HEAD as parent
            const newCommit = await github.rest.git.createCommit({
              owner: headOwner,
              repo: headRepo,
              message: squashMessage,
              tree: headCommit.data.tree.sha,
              parents: [headSha],
            });

            // Update the branch IN THE HEAD REPO 
            await github.rest.git.updateRef({
              owner: headOwner,
              repo: headRepo,
              ref: `heads/${branch}`,
              sha: newCommit.data.sha,
              force: true,
            });

            // Delete the original commits by creating a new branch with only the squashed commit
            // First, create a new branch name
            const newBranchName = `${branch}-squashed-${Date.now()}`;
            
            // Create the new branch with only the squashed commit
            await github.rest.git.createRef({
              owner: headOwner,
              repo: headRepo,
              ref: `refs/heads/${newBranchName}`,
              sha: newCommit.data.sha
            });
            
            // Update the PR to point to the new branch
            await github.rest.pulls.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
              head: `${headOwner}:${newBranchName}`
            });
            
            // Delete the old branch (this will remove all traces of original commits)
            await github.rest.git.deleteRef({
              owner: headOwner,
              repo: headRepo,
              ref: `heads/${branch}`
            });

            core.setOutput("squashed_result", "success");