name: Squash

on:
  workflow_call:
    inputs:
      username:
        description: 'User that triggered the workflow'
        required: true
        type: string
      owner:
        description: 'Organization'
        required: true
        type: string
      repo:
        description: 'Repository'
        required: true
        type: string
      pr_number:
        description: 'PR Number'
        required: true
        type: number
      comment_id:
        description: 'Comment ID'
        required: true
        type: number
    secrets:
      token:
        description: 'Personal Access Token with RW access to repo contents, PRs'
        required: true

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  RW_PAT: ${{ secrets.token }}
  USERNAME: ${{ inputs.username }}
  OWNER: ${{ inputs.owner }}
  REPO: ${{ inputs.repo }}
  PR_NUMBER: ${{ inputs.pr_number }}
  COMMENT_ID: ${{ inputs.comment_id }}

concurrency:
  group: squash-operations-${{ inputs.owner }}-${{ inputs.repo }}
  cancel-in-progress: false

jobs:
  squash-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Comment start
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const commentId = process.env.COMMENT_ID;
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const { data: comment } = await github.rest.issues.getComment({
              owner,
              repo,
              comment_id: commentId,
            });
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            let appendMsg = "\n # üóúÔ∏è Squash workflow started #\n";
            appendMsg = appendMsg + `[üñ•Ô∏è View this workflow run](${runUrl})`;
            appendMsg = appendMsg + "\n**_(Step 1/3)_** Initializing \n - Checking user permissions.";
            const newBody = comment.body + appendMsg;
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: commentId,
              body: newBody,
            });

      - name: Squash commits
        id: squash
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const prNumber = process.env.PR_NUMBER;
            
            try {
              // Get the PR details
              const pr = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber,
              });
              
              // Get commits for this PR
              const commitsResponse = await github.rest.pulls.listCommits({
                owner,
                repo,
                pull_number: prNumber,
              });
              
              const commits = commitsResponse.data;
              const headRef = pr.data.head.ref;
              const baseRef = pr.data.base.ref;
              const prTitle = pr.data.title;
              
              // Skip if there's only one commit
              if (commits.length <= 1) {
                core.info(`PR has only ${commits.length} commit(s), skipping squash`);
                core.setOutput("squash_result", "skipped");
                return;
              }
              
              // Get the base commit (common ancestor)
              const baseCommitResponse = await github.rest.repos.compareCommits({
                owner,
                repo,
                base: baseRef,
                head: headRef
              });
              
              // Get the base commit SHA
              const baseCommitSha = baseCommitResponse.data.base_commit.sha;
              
              // Get the current branch reference
              const { data: refData } = await github.rest.git.getRef({
                owner,
                repo,
                ref: `heads/${headRef}`
              });
              const currentBranchSha = refData.object.sha;
              
              // Get the current commit to extract tree SHA
              const { data: commitData } = await github.rest.git.getCommit({
                owner,
                repo,
                commit_sha: currentBranchSha
              });
              const currentTreeSha = commitData.tree.sha;
              
              // Combine all commit messages
              const msgs = commits.map(commit => `${commit.commit.message}\n`).join('');
              const subject = `${prTitle} - Squash`;
              const body = msgs;
              
              // Create a new commit with the same tree but combined messages
              const { data: newCommit } = await github.rest.git.createCommit({
                owner,
                repo,
                message: subject,
                body: body,
                tree: currentTreeSha,
                parents: [baseCommitSha]  // Point to base commit instead of current commit
              });
              
              // Update the branch reference to point to the new commit
              await github.rest.git.updateRef({
                owner,
                repo,
                ref: `heads/${headRef}`,
                sha: newCommit.sha,
                force: true
              });
              
              core.info(`Successfully squashed ${commits.length} commits into a single commit`);
              core.setOutput("squash_result", "success");
            } catch (error) {de
              core.setFailed(`Failed to squash commits: ${error.message}`);
              core.setOutput("squash_result", "failed");
            }
            
      - name: Comment result
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const commentId = process.env.COMMENT_ID;
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const { data: comment } = await github.rest.issues.getComment({
              owner,
              repo,
              comment_id: commentId,
            });
            
            // Get the squash result from the previous step
            const squashResult = process.env.SQUASH_RESULT || "success";
            let appendMsg = "";
            
            if (squashResult === "success") {
              appendMsg = "\n - Commits squashed successfully!";
            } else if (squashResult === "skipped") {
              appendMsg = "\n - PR has only one commit, skipping squash.";
            } else {
              appendMsg = "\n - Failed to squash commits. Please check the workflow logs.";
            }
            
            const newBody = comment.body + appendMsg;
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: commentId,
              body: newBody,
            });