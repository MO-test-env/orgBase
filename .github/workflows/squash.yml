name: Squash

on:
  workflow_dispatch:
    inputs:
      pr_number:
        description: "PR Number"
        required: true
        type: number

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  RW_PAT: ${{ secrets.GITHUB_TOKEN }}

jobs:
  squash-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - name: Check PR commits
        id: check
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const prNumber = parseInt("${{ inputs.pr_number }}");
            const { owner, repo } = context.repo;

            const commits = await github.rest.pulls.listCommits({
              owner,
              repo,
              pull_number: prNumber,
            });

            core.setOutput(
              "squash_result",
              commits.data.length > 1 ? "proceed" : "skipped"
            );

      - name: Squash commits (API only)
        if: steps.check.outputs.squash_result == 'proceed'
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const prNumber = parseInt(core.getInput("pr_number"));

            //
            // 1️⃣ Load PR
            //
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            // The PR branch lives here:
            const headOwner = pr.data.head.repo.owner.login;
            const headRepo  = pr.data.head.repo.name;
            const headRef   = pr.data.head.ref;   // branch name
            const headSha   = pr.data.head.sha;

            //
            // 2️⃣ Collect PR commit messages
            //
            const commits = await github.rest.pulls.listCommits({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber,
            });

            const squashMessage =
              `Squash ${commits.data.length} commits\n\n` +
              commits.data.map(c => `- ${c.
