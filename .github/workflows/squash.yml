name: Squash

on:
  workflow_call:
    inputs:
      username:
        description: 'User that triggered the workflow'
        required: true
        type: string
      owner:
        description: 'Organization'
        required: true
        type: string
      repo:
        description: 'Repository'
        required: true
        type: string
      pr_number:
        description: 'PR Number'
        required: true
        type: number
      comment_id:
        description: 'Comment ID'
        required: true
        type: number
    secrets:
      token:
        description: 'Personal Access Token with RW access to repo contents, PRs'
        required: true

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  RW_PAT: ${{ secrets.token }}
  USERNAME: ${{ inputs.username }}
  OWNER: ${{ inputs.owner }}
  REPO: ${{ inputs.repo }}
  PR_NUMBER: ${{ inputs.pr_number }}
  COMMENT_ID: ${{ inputs.comment_id }}

concurrency:
  group: squash-operations-${{ inputs.owner }}-${{ inputs.repo }}
  cancel-in-progress: false

jobs:
  squash-pr:
    runs-on: ubuntu-latest
    timeout-minutes: 3
    steps:
      - name: Comment start
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const commentId = process.env.COMMENT_ID;
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const { data: comment } = await github.rest.issues.getComment({
              owner,
              repo,
              comment_id: commentId,
            });
            const runUrl = `https://github.com/${owner}/${repo}/actions/runs/${process.env.GITHUB_RUN_ID}`;
            let appendMsg = "\n # üóúÔ∏è Squash workflow started #\n";
            appendMsg = appendMsg + `[üñ•Ô∏è View this workflow run](${runUrl})`;
            appendMsg = appendMsg + "\n**_(Step 1/3)_** Initializing \n - Checking user permissions.";
            const newBody = comment.body + appendMsg;
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: commentId,
              body: newBody,
            });

      - name: Squash commits
        id: squash
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const prNumber = process.env.PR_NUMBER;
            
            try {
              // Get the PR details
              const pr = await github.rest.pulls.get({
                owner,
                repo,
                pull_number: prNumber,
              });
              
              // Get commits for this PR
              const commitsResponse = await github.rest.pulls.listCommits({
                owner,
                repo,
                pull_number: prNumber,
              });
              
              // Check if there's more than one commit to squash
              if (commitsResponse.data.length <= 1) {
                core.setOutput("squash_result", "skipped");
                return;
              }
              
              // Get the base commit (first commit in the PR)
              const baseCommit = commitsResponse.data[0];
              
              // Get the head commit (last commit in the PR)
              const headCommit = commitsResponse.data[commitsResponse.data.length - 1];
              
              // Create a new commit that squashes all commits
              // We'll use the head commit as the base and add all the changes
              const squashCommitMessage = `Squashed ${commitsResponse.data.length} commits\n\n` +
                commitsResponse.data.map(commit => `- ${commit.commit.message}`).join('\n');
              
              // Get the base branch reference
              const baseRef = pr.data.base.ref;
              
              // Get the base commit SHA
              const baseCommitSha = pr.data.base.sha;
              
              // Get the head commit SHA
              const headCommitSha = pr.data.head.sha;
              
              // Create a new branch for the squash operation
              const squashBranchName = `squash-${prNumber}-${Date.now()}`;
              
              // Create the squash branch from the base
              await github.rest.git.createRef({
                owner,
                repo,
                ref: `refs/heads/${squashBranchName}`,
                sha: baseCommitSha,
              });
              
              // Get the files that were changed in the PR
              const filesResponse = await github.rest.pulls.listFiles({
                owner,
                repo,
                pull_number: prNumber,
              });
              
              // Apply all the changes to the squash branch
              for (const file of filesResponse.data) {
                // Get the content of the file at the head commit
                try {
                  const contentResponse = await github.rest.repos.getContent({
                    owner,
                    repo,
                    path: file.filename,
                    ref: headCommitSha,
                  });
                  
                  // Update the file on the squash branch
                  await github.rest.repos.createOrUpdateFileContents({
                    owner,
                    repo,
                    path: file.filename,
                    message: squashCommitMessage,
                    content: contentResponse.data.content,
                    branch: squashBranchName,
                  });
                } catch (error) {
                  // If the file doesn't exist in the base, create it
                  if (error.status === 404) {
                    // Get the content of the file at the head commit
                    const contentResponse = await github.rest.repos.getContent({
                      owner,
                      repo,
                      path: file.filename,
                      ref: headCommitSha,
                    });
                    
                    // Create the file on the squash branch
                    await github.rest.repos.createOrUpdateFileContents({
                      owner,
                      repo,
                      path: file.filename,
                      message: squashCommitMessage,
                      content: contentResponse.data.content,
                      branch: squashBranchName,
                    });
                  } else {
                    throw error;
                  }
                }
              }
              
              // Update the PR to point to the new squash branch
              await github.rest.pulls.update({
                owner,
                repo,
                pull_number: prNumber,
                head: `${owner}:${squashBranchName}`,
              });
              
              core.setOutput("squash_result", "success");
            } catch (error) {
              core.setFailed(`Failed to squash commits: ${error.message}`);
              core.setOutput("squash_result", "failed");
            }
            
      - name: Comment result
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const commentId = process.env.COMMENT_ID;
            const owner = process.env.OWNER;
            const repo = process.env.REPO;
            const { data: comment } = await github.rest.issues.getComment({
              owner,
              repo,
              comment_id: commentId,
            });
            
            // Get the squash result from the previous step
            const squashResult = "${{ steps.squash.outputs.squash_result }}";
            let appendMsg = "";
            
            if (squashResult === "success") {
              appendMsg = "\n - Commits squashed successfully!";
            } else if (squashResult === "skipped") {
              appendMsg = "\n - PR has only one commit, skipping squash.";
            } else {
              appendMsg = "\n - Failed to squash commits. Please check the workflow logs.";
            }
            
            const newBody = comment.body + appendMsg;
            await github.rest.issues.updateComment({
              owner,
              repo,
              comment_id: commentId,
              body: newBody,
            });