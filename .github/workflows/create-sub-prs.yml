name: Create Submodule PRs (on PR open)

on:
  pull_request:
    types: [opened, reopened, synchronize]

permissions:
  contents: write          # needed to push branches in submodules
  issues: write            # needed to comment on PRs
  pull-requests: write
  actions: read

env:
  CROSS_TOKEN: ${{ secrets.WORKFLOWS }}
  GH_TOKEN: ${{ secrets.WORKFLOWS }}

jobs:
  submodule-prs:
    runs-on: ubuntu-latest
    steps:
      # -----------------------------------------------------------
      # 1Ô∏è‚É£ Checkout base repo
      # -----------------------------------------------------------
      - name: Checkout base repo
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0

      # -----------------------------------------------------------
      # 2Ô∏è‚É£ Get changed files for the base PR
      # -----------------------------------------------------------
      - name: Get changed files
        id: changed
        run: |
          gh api \
            repos/${{ github.repository }}/pulls/${{ github.event.pull_request.number }}/files \
            --paginate \
            --jq '.[].filename' > changed_files.txt
        env:
          GH_TOKEN: ${{ env.GH_TOKEN }}

      # -----------------------------------------------------------
      # 3Ô∏è‚É£ Detect changed submodules
      # -----------------------------------------------------------
      - name: Detect changed submodules
        id: detect
        run: |
          echo "[]" > submodules.json

          if [ -f .gitmodules ]; then
            git config --file .gitmodules --get-regexp path | while read key path; do
              url=$(git config --file .gitmodules submodule."$path".url)

              if grep -q "^$path$" changed_files.txt; then
                repo=$(basename "$url" .git)

                tmp=$(mktemp)
                jq --arg path "$path" \
                  --arg url "$url" \
                  --arg repo "$repo" \
                  '. += [{"path": $path, "url": $url, "repo": $repo}]' \
                  submodules.json > "$tmp" && mv "$tmp" submodules.json
              fi
            done
          fi

          # ‚úÖ Use heredoc for multiline JSON
          {
            echo "submodules_json<<EOF"
            cat submodules.json
            echo "EOF"
          } >> "$GITHUB_OUTPUT"


      # -----------------------------------------------------------
      # 4Ô∏è‚É£ Create PRs in changed submodules
      # -----------------------------------------------------------
      - name: Create submodule PRs
        id: create
        if: ${{ steps.detect.outputs.submodules_json != '[]' }}
        run: |
          branch="${{ github.head_ref }}"
          pr_number=${{ github.event.pull_request.number }}

          jq -c '.[]' <<< '${{ steps.detect.outputs.submodules_json }}' | while read sub; do
            path=$(jq -r .path <<< "$sub")
            url=$(jq -r .url <<< "$sub")

            # Normalize URL (convert git@ to https://)
            clean_url=${url/git@github.com:/https:\/\/github.com\/}
            repo=$(basename "$clean_url" .git)
            owner=$(basename "$(dirname "$clean_url")")

            echo "üîé Processing $owner/$repo at $path"

            # Build authenticated URL
            auth_url="https://${GH_TOKEN}@github.com/${owner}/${repo}.git"

            # Clone the submodule repo with token
            git clone "$auth_url" "$repo"
            cd "$repo"

            # Ensure we‚Äôre on default branch (fetch all first)
            git fetch origin --prune
            git checkout main || git checkout -b main origin/main

            # Create or reuse branch with same name as base PR
            if git ls-remote --exit-code origin "refs/heads/$branch"; then
              echo "‚úÖ Branch $branch already exists in $repo"
              git fetch origin $branch
              git checkout $branch
            else
              echo "üå± Creating new branch $branch in $repo"
              git checkout -b "$branch"
              git push origin "$branch"
            fi

            # Create or reuse a PR in the submodule
            pr_url=$(gh pr create \
              --title "Sync from base PR #$pr_number" \
              --body "This PR was automatically created from ${{ github.repository }}#${pr_number}" \
              --head "$branch" \
              --base main \
              --repo "${owner}/${repo}" || true)

            pr_num=null
            if [[ "$pr_url" == https* ]]; then
              pr_num=$(basename "$pr_url")
            else
              # try to fetch existing PR number if creation failed
              existing=$(gh pr list --head "$branch" --base main --repo "${owner}/${repo}" --json number -q '.[0].number' || true)
              if [[ -n "$existing" ]]; then
                pr_num=$existing
              fi
            fi

            cd ..

            # Update JSON entry with pr_number
            tmp=$(mktemp)
            jq --arg path "$path" \
               --arg url "$url" \
               --arg repo "$repo" \
               --argjson pr_number "$pr_num" \
               'map(if .path == $path then . + {pr_number: $pr_number} else . end)' \
               submodules.json > "$tmp" && mv "$tmp" submodules.json
          done

          # ‚úÖ Use heredoc for multiline JSON output
          {
            echo "final_json<<EOF"
            cat submodules.json
            echo "EOF"
          } >> "$GITHUB_OUTPUT"
        env:
          GH_TOKEN: ${{ env.GH_TOKEN }}

      # -----------------------------------------------------------
      # 5Ô∏è‚É£ Comment JSON summary back on base PR
      # -----------------------------------------------------------
      - name: Comment JSON on base PR
        if: ${{ steps.create.outputs.final_json != '' }}
        run: |
<<<<<<< Updated upstream
          pretty=$(jq . <<< '${{ steps.create.outputs.final_json }}')

          gh pr comment ${{ github.event.pull_request.number }} \
            --body "### Submodule PRs\n\`\`\`json\n${pretty}\n\`\`\`"
=======
          compact=$(jq -c . <<< '${{ steps.create.outputs.final_json }}')

          gh pr comment ${{ github.event.pull_request.number }} \
            --body "üîé Detected submodules (cached for downstream workflows):\n\n\`\`\`json\n${compact}\n\`\`\`"
>>>>>>> Stashed changes
        env:
          GH_TOKEN: ${{ env.GH_TOKEN }}
