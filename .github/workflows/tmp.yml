name: Auto-Revert Submodule Matrix + Base PR (on /revert comment)
## /revert:branch to set branch thats not main 
## /revert --dry-run for safe testing 

# im gonna have to fix this so that the bump is based on tgt branch not always main 
#- sometimes delivering to feature branches - or we just close pr and do it that way 

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  CROSS_TOKEN: ${{ secrets.WORKFLOWS }}

jobs:
  # 1Ô∏è‚É£ Detect /revert command and extract cached submodules
  detect-submodules:
    if: |
      github.event.issue.pull_request != null &&
      startsWith(github.event.comment.body, '/revert') &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest
    outputs:
      submodules: ${{ steps.extract.outputs.submodules }}
      base_branch: ${{ steps.branch.outputs.base_branch }}
      dry_run: ${{ steps.flags.outputs.dry_run }}
    steps:
      - id: extract
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            const cache = comments.find(c => /<!-- SUBMODULES_JSON -->/.test(c.body));
            if (!cache) throw new Error("No cached submodule comment found");
            const jsonMatch = cache.body.match(/```json\s*([\s\S]*?)\s*```/);
            if (!jsonMatch) throw new Error("Failed to parse JSON from cached comment");
            core.setOutput('submodules', jsonMatch[1]);

      - id: branch
        run: |
          # Default base branch
          BASE_BRANCH="main"
          # Allow override in comment like: /revert:develop
          if [[ "${{ github.event.comment.body }}" =~ /revert:([a-zA-Z0-9._/-]+) ]]; then
            BASE_BRANCH="${BASH_REMATCH[1]}"
          fi
          echo "base_branch=$BASE_BRANCH" >> $GITHUB_OUTPUT

      - id: flags
        run: |
          DRY_RUN="false"
          if [[ "${{ github.event.comment.body }}" == *"--dry-run"* ]]; then
            DRY_RUN="true"
          fi
          echo "dry_run=$DRY_RUN" >> $GITHUB_OUTPUT

  # 2Ô∏è‚É£ Revert submodule PRs in parallel (API-only)
  revert-submodules:
    needs: detect-submodules
    if: ${{ needs.detect-submodules.outputs.submodules != '' }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        submod: ${{ fromJson(needs.detect-submodules.outputs.submodules) }}
      max-parallel: 6
    outputs:
      results: ${{ steps.result.outputs.summary }}
    steps:
      - id: result
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            const dryRun = ${{ needs.detect-submodules.outputs.dry_run == 'true' && 'true' || 'false' }};
            const sub = ${{ toJson(matrix.submod) }};
            const url = new URL(sub.url);
            const [owner, repo] = url.pathname.replace(/^\\//,'').replace(/\\.git$/,'').split('/');
            const pr = sub.pr_number;

            if (!pr) {
              core.info(`‚è≠Ô∏è Skipping ${repo}, no PR number`);
              core.setOutput('summary', JSON.stringify({repo, pr, status: 'skipped'}));
              return;
            }

            try {
              const { data: prData } = await github.rest.pulls.get({ owner, repo, pull_number: pr });
              if (!prData.merged) {
                core.info(`‚ö†Ô∏è ${repo} PR #${pr} not merged, skipping`);
                core.setOutput('summary', JSON.stringify({repo, pr, status: 'not-merged'}));
                return;
              }

              const mergeSha = prData.merge_commit_sha;
              const { data: mainRef } = await github.rest.git.getRef({ owner, repo, ref: "heads/main" });
              const revertBranch = `revert-pr-${pr}-${Date.now()}`;

              if (dryRun === "true") {
                core.info(`üß™ DRY-RUN: Would revert PR #${pr} in ${repo}`);
                core.setOutput('summary', JSON.stringify({repo, pr, status: 'dry-run'}));
                return;
              }

              await github.rest.git.createRef({
                owner, repo, ref: `refs/heads/${revertBranch}`, sha: mainRef.object.sha,
              });

              const message = `Revert PR #${pr}: ${mergeSha}`;
              const { data: commit } = await github.rest.git.createCommit({
                owner, repo, message, tree: prData.base.sha, parents: [mainRef.object.sha],
              });

              await github.rest.git.updateRef({
                owner, repo, ref: `heads/${revertBranch}`, sha: commit.sha, force: true,
              });

              const { data: revertPR } = await github.rest.pulls.create({
                owner, repo, title: `Revert PR #${pr}`, head: revertBranch, base: "main",
                body: `Automated revert of PR #${pr} (commit ${mergeSha})`,
              });

              await github.rest.pulls.merge({
                owner, repo, pull_number: revertPR.number, merge_method: "squash",
              });

              core.info(`‚úÖ Reverted PR #${pr} in ${repo}`);
              core.setOutput('summary', JSON.stringify({repo, pr, status: 'reverted'}));
            } catch (err) {
              core.error(`‚ùå Failed revert in ${repo}: ${err.message}`);
              core.setOutput('summary', JSON.stringify({repo, pr, status: 'failed', error: err.message}));
            }

  # 3Ô∏è‚É£ Revert base repo PR after submodules
  revert-base:
    needs: [detect-submodules, revert-submodules]
    runs-on: ubuntu-latest
    steps:
      - name: Revert base PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            const dryRun = ${{ needs.detect-submodules.outputs.dry_run == 'true' && 'true' || 'false' }};
            const baseBranch = "${{ needs.detect-submodules.outputs.base_branch }}";
            const prNumber = context.issue.number;

            const { data: prData } = await github.rest.pulls.get({
              owner: context.repo.owner, repo: context.repo.repo, pull_number: prNumber,
            });
            if (!prData.merged) {
              core.info(`‚ö†Ô∏è Base PR #${prNumber} not merged`);
              return;
            }

            const mergeSha = prData.merge_commit_sha;
            const { data: mainRef } = await github.rest.git.getRef({
              owner: context.repo.owner, repo: context.repo.repo, ref: `heads/${baseBranch}`,
            });

            if (dryRun === "true") {
              core.info(`üß™ DRY-RUN: Would revert Base PR #${prNumber}`);
              return;
            }

            const revertBranch = `revert-base-pr-${prNumber}-${Date.now()}`;
            await github.rest.git.createRef({
              owner: context.repo.owner, repo: context.repo.repo,
              ref: `refs/heads/${revertBranch}`, sha: mainRef.object.sha,
            });

            const message = `Revert Base PR #${prNumber}: ${mergeSha}`;
            const { data: commit } = await github.rest.git.createCommit({
              owner: context.repo.owner, repo: context.repo.repo,
              message, tree: prData.base.sha, parents: [mainRef.object.sha],
            });

            await github.rest.git.updateRef({
              owner: context.repo.owner, repo: context.repo.repo,
              ref: `heads/${revertBranch}`, sha: commit.sha, force: true,
            });

            const { data: revertPR } = await github.rest.pulls.create({
              owner: context.repo.owner, repo: context.repo.repo,
              title: `Revert Base PR #${prNumber}`, head: revertBranch, base: baseBranch,
              body: `Automated revert of Base PR #${prNumber} (commit ${mergeSha})`,
            });

            await github.rest.pulls.merge({
              owner: context.repo.owner, repo: context.repo.repo,
              pull_number: revertPR.number, merge_method: "squash",
            });

            core.info(`‚úÖ Reverted Base PR #${prNumber}`);

  # 4Ô∏è‚É£ Post summary as PR comment
  summarize:
    needs: [detect-submodules, revert-submodules, revert-base]
    runs-on: ubuntu-latest
    steps:
      - name: Post revert summary
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const results = [${{ needs.revert-submodules.outputs.results }}].filter(Boolean);
            const baseBranch = "${{ needs.detect-submodules.outputs.base_branch }}";
            const dryRun = "${{ needs.detect-submodules.outputs.dry_run }}";
            let body = `### üîÑ Auto-Revert Summary\n- Base branch: \`${baseBranch}\`\n- Dry-run: \`${dryRun}\`\n\n`;

            for (const r of results) {
              try {
                const parsed = typeof r === 'string' ? JSON.parse(r) : r;
                body += `- **${parsed.repo}** PR #${parsed.pr}: ${parsed.status}\n`;
                if (parsed.error) body += `  - Error: ${parsed.error}\n`;
              } catch {}
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body,
            });
