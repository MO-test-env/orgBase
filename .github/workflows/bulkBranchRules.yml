name: Bulk Branch Rule Creation (GitHub REST)

on:
  workflow_dispatch:
    inputs:
      org:
        description: 'Organization name'
        required: true
        default: 'MO-test-env'
      repo_filter:
        description: 'Optional: comma-separated repos to include (empty = all repos)'
        required: false
        default: ''
      branch:
        description: 'Branch to protect (use "default" to use each repo default branch)'
        required: true
        default: 'default'
      dry_run:
        description: 'If "true", show what would be done without making requests'
        required: false
        default: 'false'
      concurrency:
        description: 'Max parallel requests (per job strategy.max-parallel)'
        required: false
        default: '6'

permissions:
  contents: read

env:
  RW_PAT: ${{ secrets.WORKFLOWS }}

jobs:
  list-repos:
    runs-on: ubuntu-latest
    outputs:
      repos_json: ${{ steps.get_repos.outputs.repos_json }}
    steps:
      - name: Get repositories in org (REST API)
        id: get_repos
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const org = `${{ github.event.inputs.org }}`;
            const repoFilter = `${{ github.event.inputs.repo_filter }}`;
            const repos = [];
            let page = 1;
            const per_page = 100;

            while (true) {
              const { data } = await github.rest.repos.listForOrg({
                org,
                per_page,
                page,
                type: 'all'
              });
              if (data.length === 0) break;
              repos.push(...data.map(r => r.name));
              if (data.length < per_page) break;
              page++;
            }

            let filtered = repos;
            if (repoFilter) {
              const wanted = repoFilter.split(',').map(r => r.trim());
              filtered = repos.filter(r => wanted.includes(r));
            }

            core.info(`Repos found: ${filtered.length}`);
            core.setOutput('repos_json', JSON.stringify(filtered));

  apply-protection:
    needs: list-repos
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        repo: ${{ fromJson(needs.list-repos.outputs.repos_json) }}
      max-parallel: ${{ github.event.inputs.concurrency }}

    steps:
      - name: Apply Branch Protection 
        id: protect
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const org = core.getInput('org');
            const dryRun = core.getInput('dry_run') === 'true';
            const branchInput = core.getInput('branch');
            const repo = '${{ matrix.repo }}';

            core.info(`Processing repository: ${org}/${repo}`);

            // Get repo metadata
            const { data: repoInfo } = await github.rest.repos.get({
              owner: org,
              repo,
            });
            const defaultBranch = repoInfo.default_branch;
            const branch = branchInput === 'default' ? defaultBranch : branchInput;

            core.info(`Target branch: ${branch}`);

            const protection = {
              required_status_checks: {
                strict: true,
                contexts: []
              },
              enforce_admins: true,
              required_pull_request_reviews: {
                dismiss_stale_reviews: true,
                require_code_owner_reviews: true,
                required_approving_review_count: 1
              },
              restrictions: null
            };

            core.info('Branch protection configuration:');
            core.info(JSON.stringify(protection, null, 2));

            if (dryRun) {
              core.info('üü° DRY RUN: No changes applied.');
              return;
            }

            // Apply or update branch protection
            try {
              await github.rest.repos.updateBranchProtection({
                owner: org,
                repo,
                branch,
                ...protection
              });
              core.info(`‚úÖ Branch protection applied to ${org}/${repo}@${branch}`);
            } catch (error) {
              core.error(`‚ùå Failed to apply branch protection for ${repo}@${branch}`);
              core.error(error);
              throw error;
            }

      - name: Done (log)
        if: always()
        run: |
          echo "Finished processing ${{ matrix.repo }}"
