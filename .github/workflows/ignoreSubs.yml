name: Auto-Merge PRs Ignoring Submodule Conflicts

on:
  pull_request:
    types: [opened, reopened, synchronize]

jobs:
  auto-merge-submodules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout PR branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.ref }}
          submodules: recursive

      - name: Fetch target branch
        run: |
          git fetch origin ${{ github.event.pull_request.base.ref }}

      - name: Generate temporary .gitattributes for submodules
        run: |
          echo "# Temporary .gitattributes for GitHub PR merge" > .gitattributes
          git config --file .gitmodules --get-regexp path | awk '{print $2}' | while read sub; do
            echo "$sub merge=ours" >> .gitattributes
          done
          cat .gitattributes

      - name: Configure 'ours' merge driver
        run: git config merge.ours.driver true

      - name: Merge target branch into PR branch
        run: |
          git merge origin/${{ github.event.pull_request.base.ref }} --no-commit || true
          # Add all submodules to resolve conflicts automatically
          git config --file .gitmodules --get-regexp path | awk '{print $2}' | xargs git add
          git commit -m "Auto-merge target branch ignoring submodule conflicts" || echo "No changes to commit"

      - name: Push merge result
        uses: ad-m/github-push-action@v0.6.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          branch: ${{ github.event.pull_request.head.ref }}
