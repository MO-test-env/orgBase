name: Create/ Link PR

on:
  pull_request:
    types: [opened, reopened, synchronize]

env:
  RW_PAT: ${{ secrets.WORKFLOWS }}

jobs:
  discover-submodules:
    name: Discover Submodules
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.matrix.outputs.matrix }}
      has-submodules: ${{ steps.matrix.outputs.has-submodules }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 0
          token: ${{ env.RW_PAT }}

      - name: Authenticate submodules
        run: |
          git config --global url."https://${RW_PAT}@github.com/".insteadOf "https://github.com/"
          git config --global url."https://${RW_PAT}@github.com/MO-test-env/".insteadOf "../"
          git submodule sync --recursive
          git submodule update --init --recursive
        env:
          RW_PAT: ${{ env.RW_PAT }}

      - name: Get changed files
        id: changed
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const prNumber = context.payload.pull_request.number;
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            let files = [];
            let page = 1;
            while (true) {
              const { data } = await github.rest.pulls.listFiles({
                owner,
                repo,
                pull_number: prNumber,
                per_page: 100,
                page
              });
              if (data.length === 0) break;
              files.push(...data.map(f => f.filename));
              page++;
            }
            core.setOutput("changed_files", JSON.stringify(files));

      - name: Read .gitmodules
        id: gitmodules
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            try {
              const { data: contentData } = await github.rest.repos.getContent({
                owner: context.repo.owner,
                repo: context.repo.repo,
                path: '.gitmodules',
                ref: context.payload.pull_request.head.sha
              });

              const decoded = Buffer.from(contentData.content, 'base64').toString();
              const regex = /\[submodule "(.*?)"\]\s+path = (.*?)\s+url = (.*?)$/gm;
              let match;
              let submodules = [];
              while ((match = regex.exec(decoded)) !== null) {
                const repoName = match[3].replace(/^.*[\\/]/, '').replace(/\.git$/i, '');
                const fullUrl = `https://github.com/MO-test-env/${repoName}`;
                submodules.push({
                  name: match[1],
                  path: match[2],
                  repo: repoName,
                  url: fullUrl
                });
              }
              core.setOutput("submodules_json", JSON.stringify(submodules));
            } catch (e) {
              core.setOutput("submodules_json", "[]");
            }

      - name: Filter changed submodules
        id: detect
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const changedFiles = JSON.parse('${{ steps.changed.outputs.changed_files }}' || '[]');
            const submodules = JSON.parse('${{ steps.gitmodules.outputs.submodules_json }}' || '[]');
            const changedSubs = submodules.filter(s => s?.path && changedFiles.includes(s.path.trim()));
            core.setOutput("submodules_json", JSON.stringify(changedSubs));

      - name: Generate matrix
        id: matrix
        run: |
          SUBMODULES='${{ steps.detect.outputs.submodules_json }}'
          echo "matrix=$SUBMODULES" >> $GITHUB_OUTPUT
          HAS_SUBS=false
          if [[ "$SUBMODULES" != "[]" ]]; then HAS_SUBS=true; fi
          echo "has-submodules=$HAS_SUBS" >> $GITHUB_OUTPUT

  link-and-validate:
    name: "PR Status: ${{ matrix.repo_name }}"
    needs: discover-submodules
    if: needs.discover-submodules.outputs.has-submodules == 'true'
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      checks: write
      statuses: write
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.discover-submodules.outputs.matrix) }}
    outputs:
      submodule_status: ${{ steps.status.outputs.submodule_status }}
    steps:
      - name: Extract ticket number
        id: extract
        run: |
          BRANCH_NAME="${{ github.head_ref }}"
          CODES="cbdit|cdc|cpse"
          TICKET_NUM=$(echo "$BRANCH_NAME" | grep -Eo "($CODES)-[0-9]+" | head -n1)
          echo "ticket_num=$TICKET_NUM" >> $GITHUB_OUTPUT

      - name: Check for submodule PR
        id: check_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const owner = '${{ matrix.owner }}';
            const repo = '${{ matrix.repo_name }}';
            const branchName = '${{ github.head_ref }}';

            const { data: prs } = await github.rest.pulls.list({
              owner,
              repo,
              state: 'open',
              head: `${owner}:${branchName}`
            });

            let found = false;
            let pr_url = '';
            let pr_number = '';
            if (prs.length > 0) {
              const pr = prs[0];
              found = true;
              pr_url = pr.html_url;
              pr_number = pr.number.toString();
            }

            core.setOutput('found', found.toString());
            core.setOutput('pr_url', pr_url);
            core.setOutput('pr_number', pr_number);

      - name: Validate PR approval
        id: antman
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const found = '${{ steps.check_pr.outputs.found }}' === 'true';
            let is_approved = false;
            let is_mergeable = false;
            let approvals_count = 0;
            let change_requests_count = 0;

            if (found) {
              const owner = '${{ matrix.owner }}';
              const repo = '${{ matrix.repo_name }}';
              const prNumber = parseInt('${{ steps.check_pr.outputs.pr_number }}');

              try {
                const { data: reviews } = await github.rest.pulls.listReviews({ owner, repo, pull_number: prNumber });
                const latestReviews = {};
                reviews.forEach(r => { if (r.state !== 'COMMENTED') latestReviews[r.user.login] = r; });
                const approvals = Object.values(latestReviews).filter(r => r.state === 'APPROVED');
                const changeRequests = Object.values(latestReviews).filter(r => r.state === 'CHANGES_REQUESTED');

                approvals_count = approvals.length;
                change_requests_count = changeRequests.length;

                if (approvals_count >= 2 && change_requests_count === 0) {
                  is_approved = true;
                  is_mergeable = true;
                }
              } catch(e){ console.error(e); }
            }

            core.setOutput('is_approved', is_approved.toString());
            core.setOutput('is_mergeable', is_mergeable.toString());
            core.setOutput('approvals_count', approvals_count.toString());
            core.setOutput('change_requests_count', change_requests_count.toString());

      - name: Output submodule status
        id: status
        run: |
          echo "submodule_status=$(jq -n \
            --arg repo '${{ matrix.repo_name }}' \
            --arg path '${{ matrix.path }}' \
            --arg pr_url '${{ steps.check_pr.outputs.pr_url }}' \
            --arg found '${{ steps.check_pr.outputs.found }}' \
            --arg is_approved '${{ steps.antman.outputs.is_approved }}' \
            --arg is_mergeable '${{ steps.antman.outputs.is_mergeable }}' \
            --arg approvals_count '${{ steps.antman.outputs.approvals_count }}' \
            --arg change_requests_count '${{ steps.antman.outputs.change_requests_count }}' \
            '{repo: $repo, path: $path, pr_url: $pr_url, found: $found, is_approved: $is_approved, is_mergeable: $is_mergeable, approvals_count: $approvals_count, change_requests_count: $change_requests_count}')"
          echo "submodule_status=$(cat <<< $submodule_status)" >> $GITHUB_OUTPUT

  workflow-status:
    name: "Link PR Summary"
    runs-on: ubuntu-latest
    needs: [discover-submodules, link-and-validate]
    if: always()
    steps:
      - name: Install jq
        run: sudo apt-get update && sudo apt-get install -y jq

      - name: Collect all submodule statuses
        id: collect
        run: |
          statuses="["
          for job in ${{ toJSON(needs.link-and-validate.*.outputs) }}; do
            statuses+="$job,"
          done
          statuses="${statuses%,}]"
          echo "all_submodules=$statuses" >> $GITHUB_OUTPUT

      - name: Create/Update consolidated comment
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const submodules = JSON.parse('${{ steps.collect.outputs.all_submodules }}' || '[]');
            if (submodules.length === 0) return;

            const fs = require('fs');  
            const summaryPath = process.env.GITHUB_STEP_SUMMARY;  
            let commentBody = "# ðŸ”— Linked Submodule PRs Summary\n\n## ðŸ“Š Overview\n";

            submodules.forEach(sub => {
              const pr_state = sub.found === 'true' ? 'ðŸ“‚ Open' : 'â“ Not Found';
              const approval_display = sub.is_approved === 'true' ? 'âœ… Approved' : `âš ï¸ Pending (${sub.approvals_count}/2)`;
              const result_display = (sub.is_approved === 'true' && sub.found === 'true') 
                ? "## ðŸŽ‰ Result\nThe PR check **succeeded**. The Submodule PR is mergeable and approved."
                : "## âŒ Result\nThe PR check **failed**. One or more conditions are not satisfied.";

              commentBody += 
                `### [\`${sub.repo}\`](${sub.pr_url})\n\n` +
                `| Field | Value |\n` +
                `|-------|-------|\n` +
                `| **Directory** | \`${sub.path}\` |\n` +
                `| **PR State** | ${pr_state} |\n` +
                `| **Approvals** | ${approval_display} |\n` +
                `| **Change Requests** | \`${sub.change_requests_count}\` |\n\n` +
                `${result_display}\n\n---\n\n`;
            });

            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number
            });

            const consolidatedComment = comments.find(c => c.user.type === 'Bot' && c.body.includes('ðŸ”— Linked Submodule PRs Summary'));

            if (consolidatedComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: consolidatedComment.id,
                body: commentBody
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: commentBody
              });
            }

            fs.appendFileSync(summaryPath, commentBody);
