name: Auto-Revert Submodule Matrix + Base PR (on /revert comment)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  CROSS_TOKEN: ${{ secrets.WORKFLOWS }}

jobs:
  # Detect /revert comment and cached submodule info
  detect-submodules:
    if: |
      github.event.issue.pull_request != null &&
      github.event.comment.body == '/revert' &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest
    outputs:
      submodules: ${{ steps.extract.outputs.submodules }}
    steps:
      - id: extract
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            const cache = comments.find(c => /<!-- SUBMODULES_JSON -->/.test(c.body));
            if (!cache) throw new Error("No cached submodule comment found");
            const jsonMatch = cache.body.match(/```json\s*([\s\S]*?)\s*```/);
            if (!jsonMatch) throw new Error("Failed to parse JSON from cached comment");
            core.setOutput('submodules', jsonMatch[1]);

  # Revert submodule PRs using GraphQL
  revert-submodules:
    needs: detect-submodules
    runs-on: ubuntu-latest
    strategy:
      matrix:
        submod: ${{ fromJson(needs.detect-submodules.outputs.submodules) }}
      max-parallel: 6
    steps:
      - name: Revert submodule PR via GraphQL
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            const sub = ${{ toJson(matrix.submod) }};
            const url = new URL(sub.url);
            const [owner, repo] = url.pathname.replace(/^\/|\.git$/g,'').split('/');
            const prNumber = sub.pr_number;

            core.info(`üîç Attempting GraphQL revert for ${repo} PR #${prNumber}`);

            const query = `
              mutation($input: RevertPullRequestInput!) {
                revertPullRequest(input: $input) {
                  pullRequest {
                    number
                    url
                  }
                }
              }
            `;

            const prData = await github.rest.pulls.get({
              owner,
              repo,
              pull_number: prNumber,
            });

            const response = await github.graphql(query, {
              input: { pullRequestId: prData.data.node_id }
            });

            const newPR = response.revertPullRequest.pullRequest;
            console.log(`‚úÖ Created revert PR #${newPR.number} at ${newPR.url}`);

              // Merge automatically
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: newPR.number,
                merge_method: "squash",
              });
              core.info(`‚úÖ Reverted submodule PR #${prNumber}`);
            } catch (err) {
              core.error(`üî• Failed to revert submodule PR #${prNumber} in ${repo}: ${err.message}`);
            }

  # Revert base PR using GraphQL
  revert-base:
    needs: detect-submodules
    runs-on: ubuntu-latest
    steps:
      - name: Revert base PR via GraphQL
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            core.info(`üîç Attempting GraphQL revert for base PR #${prNumber}`);

            const basePR = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });

            if (!basePR.data.merged) {
              core.info(`‚ö†Ô∏è Base PR #${prNumber} not merged. Skipping revert.`);
              return;
            }

            const query = `
              mutation($input: RevertPullRequestInput!) {
                revertPullRequest(input: $input) {
                  pullRequest { number url }
                }
              }
            `;

            const response = await github.graphql(query, {
              input: {
                pullRequestId: basePR.data.node_id,
                commitHeadline: `Revert Base PR #${prNumber}`,
                revertBranchName: `revert-base-pr-${prNumber}-${Date.now()}`,
              }
            });

            const newPR = response.revertPullRequest.pullRequest;
            core.info(`‚úÖ Created revert PR #${newPR.number} at ${newPR.url}`);

            ## hypothetcally bump here

            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: newPR.number,
              merge_method: "squash",
            });
            core.info(`‚úÖ Reverted base PR #${prNumber}`);
  
  dispatch-submodule-bump:
    needs: 
      - revert-submodules
      - revert-base
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Check and Bump Submodules workflow
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflowFileName = "bump.yml";
            const ref = "main"; // branch to run workflow on

            console.log(`üöÄ Dispatching workflow '${workflowFileName}' on ${ref}...`);

            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: workflowFileName,
              ref
            });

            console.log("‚úÖ Workflow dispatched successfully");