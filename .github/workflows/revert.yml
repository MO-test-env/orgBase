name: Revert chain

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  contents: write
  issues: write
  actions: write

env:
  RW_PAT: ${{ secrets.WORKFLOWS }}

jobs:
  revert-chain:
    if: |
      github.event.issue.pull_request != null &&
      github.event.comment.body == '/revert' &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ env.RW_PAT }}
          fetch-depth: 0
          submodules: recursive

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const prNum = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNum
            });
            if (!pr.merged) {
              core.setFailed('Base PR is not merged ‚Äì nothing to revert.');
              return;
            }
            core.setOutput('merge_sha', pr.merge_commit_sha);
            core.setOutput('base_branch', pr.base.ref);
            core.setOutput('title', pr.title);

      - name: Create revert branch and commit
        id: revert
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin ${{ steps.pr.outputs.base_branch }}
          git checkout -b revert-${{ github.event.issue.number }} origin/${{ steps.pr.outputs.base_branch }}
          git revert -m 1 ${{ steps.pr.outputs.merge_sha }} || true
          git commit -am "Revert: ${{ steps.pr.outputs.title }}" || echo "No changes to commit"
          git push origin HEAD

      - name: Create PR for base revert
        id: create-base-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const prNumber = context.issue.number;
            const revertBranch = `revert-${prNumber}`;
            const { data: newPR } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Revert "${{ steps.pr.outputs.title }}"`,
              head: revertBranch,
              base: "${{ steps.pr.outputs.base_branch }}",
              body: `This reverts PR #${prNumber}`,
            });
            core.setOutput('revert_pr', newPR.number);
            core.info(`‚úÖ Created base revert PR #${newPR.number}`);

      - name: Detect submodules changed in the reverted commit
        id: submods
        run: |
          git show ${{ steps.pr.outputs.merge_sha }} -- .gitmodules || true
          git diff-tree --no-commit-id --name-only -r ${{ steps.pr.outputs.merge_sha }} | grep -E '^[^/]+/' > submodules.txt || true
          echo "Detected submodules:"
          cat submodules.txt || echo "None"
          echo "submodules=$(cat submodules.txt | xargs)" >> $GITHUB_OUTPUT

      - name: Revert submodule PRs
        if: steps.submods.outputs.submodules != ''
        uses: actions/github-script@v7
        env:
          RW_PAT: ${{ env.RW_PAT }}
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const { execSync } = require('child_process');
            const submods = process.env.SUBMODULES ? process.env.SUBMODULES.split(/\s+/) : [];
            for (const sub of submods) {
              core.info(`üîÑ Processing submodule: ${sub}`);
              execSync(`git submodule update --init ${sub}`, { stdio: 'inherit' });
              const url = execSync(`git config -f .gitmodules submodule.${sub}.url`, { encoding: 'utf8' }).trim();
              const [_, owner, repo] = url.match(/github\.com[:/](.+?)\/(.+?)(\.git)?$/) || [];
              if (!owner || !repo) {
                core.warning(`Could not parse repo for ${sub}`);
                continue;
              }

              execSync(`git clone https://${process.env.RW_PAT}@github.com/${owner}/${repo}.git`, { stdio: 'inherit' });
              process.chdir(repo);
              execSync(`git fetch origin main`);
              execSync(`git checkout -b revert-sub-${sub} origin/main`);
              try {
                execSync(`git revert -m 1 HEAD`, { stdio: 'inherit' });
                execSync(`git push origin HEAD`, { stdio: 'inherit' });
              } catch (err) {
                core.warning(`‚ö†Ô∏è Skipped ${repo}: ${err.message}`);
                execSync(`git revert --abort || true`);
                process.chdir('..');
                continue;
              }

              const { data: newPR } = await github.rest.pulls.create({
                owner,
                repo,
                title: `Revert latest submodule commit`,
                head: `revert-sub-${sub}`,
                base: "main",
                body: `Automatically reverting last commit in ${repo}`,
              });
              await github.rest.pulls.merge({
                owner,
                repo,
                pull_number: newPR.number,
                merge_method: "squash",
              });
              process.chdir('..');
              core.info(`‚úÖ Reverted and merged ${repo}`);
            }

      - name: Update submodules and push to base revert PR
        run: |
          git submodule update --init --recursive
          git add .
          git commit -m "Update submodules after revert" || echo "No submodule updates"
          git push origin HEAD

      - name: Merge base revert PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const revertPR = parseInt("${{ steps.create-base-pr.outputs.revert_pr }}");
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: revertPR,
              merge_method: 'squash'
            });
            core.info(`‚úÖ Successfully merged base revert PR #${revertPR}`);
