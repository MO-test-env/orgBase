name: Auto-Revert Base + Submodules

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  contents: write
  issues: write
  actions: write

env:
  CROSS_TOKEN: ${{ secrets.WORKFLOWS }}


jobs:
  auto-revert:
    if: github.event.issue.pull_request && contains(github.event.comment.body, '/revert')
    runs-on: ubuntu-latest
    steps:
      # ‚úÖ Checkout with PAT (private repos + submodules)
      - name: Checkout base repo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.CROSS_TOKEN }}
          submodules: recursive
          fetch-depth: 0

      # üîë Configure Git for PAT
      - name: Configure Git auth
        run: |
          git config --global url."https://${{ secrets.CROSS_TOKEN }}@github.com/".insteadOf "https://github.com/"

      # üìå Use GraphQL to get base PR + commit info
      - name: Fetch PR data via GraphQL
        id: gql
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.CROSS_TOKEN }}
          script: |
            const query = `
              query($owner: String!, $repo: String!, $prNumber: Int!) {
                repository(owner: $owner, name: $repo) {
                  pullRequest(number: $prNumber) {
                    number
                    mergeCommit {
                      oid
                    }
                  }
                }
              }
            `;
            const result = await github.graphql(query, {
              owner: context.repo.owner,
              repo: context.repo.repo,
              prNumber: context.issue.number
            });
            return { baseSha: result.repository.pullRequest.mergeCommit.oid };

      # 1Ô∏è‚É£ Create base revert branch + PR using REST
      - name: Create base revert PR
        id: base_revert
        run: |
          branch="revert-base-${GITHUB_RUN_ID}"
          git checkout -b "$branch" "${{ steps.gql.outputs.baseSha }}^"
          git revert --no-edit "${{ steps.gql.outputs.baseSha }}"
          git push origin "$branch"

          pr_number=$(curl -s -X POST \
            -H "Authorization: token ${{ secrets.CROSS_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls \
            -d "{\"head\":\"$branch\",\"base\":\"main\",\"title\":\"Revert base commit\",\"body\":\"Auto revert base commit\"}" \
            | jq -r '.number')

          echo "pr_number=$pr_number" >> $GITHUB_OUTPUT

      # 2Ô∏è‚É£ Revert submodules
      - name: Revert submodules
        shell: bash
        env:
          GITHUB_TOKEN: ${{ secrets.CROSS_TOKEN }}
        run: |
          for sub in $(git config --file .gitmodules --get-regexp path | awk '{ print $2 }'); do
            echo "üîÑ Processing $sub"
            cd $sub
            sha=$(git rev-parse HEAD)

            branch="revert-${sub}-${GITHUB_RUN_ID}"
            git checkout -b "$branch" HEAD^
            git revert --no-edit $sha || true
            git push origin "$branch"

            repo_url=$(git config --get remote.origin.url | sed 's#git@github.com:#https://github.com/#;s#.git$##')
            owner=$(echo $repo_url | cut -d/ -f4)
            repo=$(echo $repo_url | cut -d/ -f5)

            pr_number=$(curl -s -X POST \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/$owner/$repo/pulls \
              -d "{\"head\":\"$branch\",\"base\":\"main\",\"title\":\"Revert $sub commit\",\"body\":\"Auto revert\"}" \
              | jq -r '.number')

            curl -s -X PUT \
              -H "Authorization: token $GITHUB_TOKEN" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/$owner/$repo/pulls/$pr_number/merge \
              -d '{"merge_method":"merge"}'

            cd ..
          done

      # 3Ô∏è‚É£ Update submodule SHAs in base
      - name: Update submodules in base
        run: |
          git submodule update --remote
          git add .
          git commit -m "Update submodules after revert" || echo "No changes to commit"
          git push origin HEAD

      # 4Ô∏è‚É£ Merge base revert PR
      - name: Merge base revert PR
        run: |
          pr_number=${{ steps.base_revert.outputs.pr_number }}
          if [ -n "$pr_number" ]; then
            curl -s -X PUT \
              -H "Authorization: token ${{ secrets.CROSS_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${GITHUB_REPOSITORY}/pulls/$pr_number/merge \
              -d '{"merge_method":"merge"}'
          else
            echo "‚ö†Ô∏è Base revert PR not found"
          fi
