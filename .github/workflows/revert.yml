name: Revert

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: write

env:
  RW_PAT: ${{ secrets.WORKFLOWS2 }} # RW PAT with repo + PR permissions
  MIN_REVIEWERS: 0

concurrency:
  group: ${{ github.workflow }}
  cancel-in-progress: false

jobs:
  init:
    if: |
      github.event.issue.pull_request != null &&
      github.event.comment.body == '/revert' &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      pr_number: ${{ steps.pr.outputs.pr_number }}
      pr_title: ${{ steps.pr.outputs.title }}
      head_ref: ${{ steps.pr.outputs.head_ref }}
      base_ref: ${{ steps.pr.outputs.base_ref }}
      submodules: ${{ steps.submods.outputs.submodules }}
    steps:
      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const prNumber = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput("pr_number", pr.number);
            core.setOutput("title", pr.title);
            core.setOutput("head_ref", pr.head.ref);
            core.setOutput("base_ref", pr.base.ref);

      - name: Detect Submodules from Latest Analysis Comment
        id: submods
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });
            const latest = comments.filter(c => /üîç Submodule Analysis Results/.test(c.body))
              .sort((a,b) => new Date(b.created_at)-new Date(a.created_at))[0];
            if (!latest) { core.setOutput("submodules", "[]"); return; }

            const blocks = latest.body.split(/(?=####\s*[‚úÖ‚è≥üîÑ‚ùå]\s*`)/g)
              .filter(b => /PR:/i.test(b));
            const subs = [];
            for (const block of blocks) {
              const name = block.match(/####\s*[‚úÖ‚è≥üîÑ‚ùå]\s*`([^`]+)`/)?.[1];
              const url = block.match(/\((https:\/\/github\.com\/[^)]+)\)/)?.[1];
              const pr_number = parseInt(block.match(/#(\d+)/)?.[1] || "0",10);
              if (!name || !url) continue;
              const [, org, repo] = url.match(/github\.com\/([^/]+)\/([^/]+)/) || [];
              subs.push({ name, url, org, repo, pr_number });
            }
            core.setOutput("submodules", JSON.stringify(subs,null,2));

  create-base-revert:
    needs: init
    runs-on: ubuntu-latest
    outputs:
      revert_branch: ${{ steps.revert.outputs.branch }}
      revert_pr_number: ${{ steps.revert_pr.outputs.number }}
    steps:
      - name: Checkout base repo
        uses: actions/checkout@v4
        with:
          token: ${{ env.RW_PAT }}
          ref: ${{ needs.init.outputs.base_ref }}
          fetch-depth: 0

      - name: Create Revert Branch and Commit
        id: revert
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          branch="revert-${{ needs.init.outputs.pr_number }}"
          git checkout -b "$branch"
          git revert -m 1 "origin/${{ needs.init.outputs.head_ref }}" || echo "No merge commit to revert."
          git push origin "$branch"
          echo "branch=$branch" >> $GITHUB_OUTPUT

      - name: Create Revert PR
        id: revert_pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const branch = "${{ steps.revert.outputs.branch }}";
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Revert: ${{ needs.init.outputs.pr_title }}`,
              head: branch,
              base: "${{ needs.init.outputs.base_ref }}",
              body: "Automated revert for base PR #${{ needs.init.outputs.pr_number }}."
            });
            core.setOutput("number", pr.number);

  revert-submodules:
    needs: [init]
    runs-on: ubuntu-latest
    if: ${{ needs.init.outputs.submodules != '[]' }}
    strategy:
      matrix:
        sub: ${{ fromJson(needs.init.outputs.submodules) }}
      fail-fast: false
      max-parallel: 4
    steps:
      - name: Create Revert PR in submodule
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const sub = ${{ toJson(matrix.sub) }};
            const [owner, repo] = [sub.org, sub.repo];
            const base = "main";
            const branch = `revert-${sub.pr_number}`;
            const title = `Revert: Submodule PR #${sub.pr_number}`;
            console.log(`üîÅ Creating revert PR in ${owner}/${repo}`);
            try {
              await github.rest.git.createRef({
                owner, repo,
                ref: `refs/heads/${branch}`,
                sha: (await github.rest.repos.get({owner,repo})).data.default_branch_sha
              });
            } catch (e) {
              console.log(`‚ö†Ô∏è branch may exist: ${e.message}`);
            }
            try {
              const { data: pr } = await github.rest.pulls.create({
                owner, repo,
                title,
                head: branch,
                base,
                body: "Automated revert for submodule PR.",
              });
              await github.rest.pulls.merge({
                owner, repo,
                pull_number: pr.number,
                merge_method: "squash"
              });
              console.log(`‚úÖ Merged revert PR #${pr.number} for ${repo}`);
            } catch (e) {
              console.log(`‚ö†Ô∏è Failed revert in ${repo}: ${e.message}`);
            }

  bump-submodules:
    needs: [init, revert-submodules]
    runs-on: ubuntu-latest
    if: >-
      needs.init.outputs.submodules != '[]' &&
      (needs.revert-submodules.result == 'success' || needs.revert-submodules.result == 'skipped')
    steps:
      - name: Checkout base repo
        uses: actions/checkout@v4
        with:
          token: ${{ env.RW_PAT }}
          ref: ${{ needs.init.outputs.head_ref }}
          submodules: true
          fetch-depth: 0

      - name: Bump submodules to reverted commits
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git submodule update --remote --recursive
          git add .
          git commit -m "üîÅ Bump submodules after revert chain" || echo "no changes"
          git push origin HEAD

  merge-base-revert:
    needs: [create-base-revert, bump-submodules]
    runs-on: ubuntu-latest
    steps:
      - name: Merge Base Revert PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: parseInt("${{ needs.create-base-revert.outputs.revert_pr_number }}"),
              merge_method: "squash"
            });
