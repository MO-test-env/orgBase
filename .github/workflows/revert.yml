name: Auto-Revert Submodules + Base PR

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  contents: write
  issues: write
  actions: write

env:
  CROSS_TOKEN: ${{ secrets.WORKFLOWS }}

jobs:
  detect-submodules:
    if: |
      github.event.issue.pull_request != null &&
      github.event.comment.body == '/revert' &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest
    outputs:
      submodules: ${{ steps.extract.outputs.submodules }}
    steps:
      - id: extract
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber
            });
            const cache = comments.find(c => /<!-- SUBMODULES_JSON -->/.test(c.body));
            if (!cache) { core.setOutput("submodules", "[]"); return; }
            const jsonMatch = cache.body.match(/```json\s*([\s\S]*?)\s*```/);
            core.setOutput('submodules', jsonMatch ? jsonMatch[1] : "[]");

  revert-submodules:
    needs: detect-submodules
    if: needs.detect-submodules.outputs.submodules != '[]'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        submod: ${{ fromJson(needs.detect-submodules.outputs.submodules) }}
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            const sub = ${{ toJson(matrix.submod) }};
            const url = new URL(sub.url);
            const [owner, repo] = url.pathname.replace(/^\/|\.git$/g,'').split('/');
            const prNumber = sub.pr_number;
            const branch = `revert-pr-${prNumber}`;

            const { data: pr } = await github.rest.pulls.get({ owner, repo, pull_number: prNumber });
            if (!pr.merged) return;

            let newPR;
            try {
              const revert = await github.graphql(
                `mutation($input: RevertPullRequestInput!) {
                  revertPullRequest(input: $input) {
                    pullRequest { number url }
                  }
                }`,
                {
                  input: {
                    pullRequestId: pr.node_id,
                    revertBranchName: branch
                  }
                }
              );
              newPR = revert.revertPullRequest.pullRequest;
            } catch (e) {
              if (/already exists/i.test(e.message)) {
                const { data: prs } = await github.rest.pulls.list({
                  owner,
                  repo,
                  head: `${owner}:${branch}`,
                  state: "open"
                });
                if (prs.length) newPR = prs[0];
                else throw e;
              } else throw e;
            }

            await github.rest.pulls.merge({ owner, repo, pull_number: newPR.number, merge_method: "squash" });

  revert-base:
    needs: revert-submodules
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const branch = `revert-base-pr-${prNumber}`;

            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            if (!pr.merged) return;

            let newPR;
            try {
              const revert = await github.graphql(
                `mutation($input: RevertPullRequestInput!) {
                  revertPullRequest(input: $input) {
                    pullRequest { number url }
                  }
                }`,
                {
                  input: {
                    pullRequestId: pr.node_id,
                    revertBranchName: branch
                  }
                }
              );
              newPR = revert.revertPullRequest.pullRequest;
            } catch (e) {
              if (/already exists/i.test(e.message)) {
                const { data: prs } = await github.rest.pulls.list({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  head: `${context.repo.owner}:${branch}`,
                  state: "open"
                });
                if (prs.length) newPR = prs[0];
                else throw e;
              } else throw e;
            }

            await github.rest.pulls.merge({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: newPR.number,
              merge_method: "squash"
            });

  bump-submodules:
    needs: [revert-submodules, revert-base]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/github-script@v7
        with:
          github-token: ${{ env.CROSS_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const workflowFileName = "bump.yml";
            const ref = "main";

            console.log(`ðŸš€ Dispatching '${workflowFileName}' on ${ref}...`);
            await github.rest.actions.createWorkflowDispatch({
              owner,
              repo,
              workflow_id: workflowFileName,
              ref
            });
            console.log("âœ… Bump workflow dispatched successfully");
