name: Revert chain

on:
  issue_comment:
    types: [created]

permissions:
  pull-requests: write
  contents: write
  issues: write
  actions: write

env:
  RW_PAT: ${{ secrets.WORKFLOWS }}

jobs:
  revert-chain:
    if: |
      github.event.issue.pull_request != null &&
      github.event.comment.body == '/revert' &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          token: ${{ env.RW_PAT }}
          fetch-depth: 0
          submodules: recursive

      - name: Get PR info
        id: pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const prNum = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNum
            });
            if (!pr.merged) {
              core.setFailed('Base PR is not merged ‚Äì nothing to revert.');
              return;
            }
            core.setOutput('merge_sha', pr.merge_commit_sha);
            core.setOutput('base_branch', pr.base.ref);
            core.setOutput('title', pr.title);

      - name: Print full diff of merged commit
        run: |
          echo "================= FULL DIFF FOR DEBUG ================="
          git show --submodule=diff ${{ steps.pr.outputs.merge_sha }} || true
          echo "========================================================"

      - name: Detect submodule commits changed in merge
        id: submods
        run: |
          echo "üîç Detecting submodule diffs..."
          # We look for lines that start with 'Submodule <path>'
          git diff-tree -r --summary ${{ steps.pr.outputs.merge_sha }} | grep '^Submodule' || true

          # Extract submodule name and the two SHAs
          git diff-tree -r --summary ${{ steps.pr.outputs.merge_sha }} | \
            awk '/Submodule/ {print $2,$4,$6}' > submods.txt || true

          echo "Detected submodule diffs:"
          cat submods.txt || echo "None found"
          subs=$(awk '{print $1}' submods.txt | xargs)
          echo "submodules=$subs" >> $GITHUB_OUTPUT

      - name: Create revert branch for base repo
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git fetch origin ${{ steps.pr.outputs.base_branch }}
          git checkout -b revert-${{ github.event.issue.number }} origin/${{ steps.pr.outputs.base_branch }}
          git revert -m 1 ${{ steps.pr.outputs.merge_sha }} || true
          git commit -am "Revert: ${{ steps.pr.outputs.title }}" || echo "No base changes to commit"
          git push origin HEAD

      - name: Create revert PR for base repo
        id: basepr
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const revertBranch = `revert-${context.issue.number}`;
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `Revert "${{ steps.pr.outputs.title }}"`,
              head: revertBranch,
              base: "${{ steps.pr.outputs.base_branch }}",
              body: `Automatically reverting PR #${context.issue.number}`
            });
            core.setOutput('revert_pr', pr.number);
            core.info(`‚úÖ Created base revert PR #${pr.number}`);

      - name: Revert submodules
        if: steps.submods.outputs.submodules != ''
        run: |
          set -e
          echo "üîÑ Processing submodule reverts..."
          while read sub old new; do
            echo "‚û°Ô∏è Submodule: $sub"
            echo "   Old SHA: $old"
            echo "   New SHA: $new"

            # Get submodule repo URL from .gitmodules
            url=$(git config -f .gitmodules submodule.${sub}.url)
            if [ -z "$url" ]; then
              echo "‚ö†Ô∏è Could not determine URL for $sub, skipping."
              continue
            fi

            # Parse owner and repo
            owner=$(echo "$url" | sed -E 's|.*github.com[:/](.+?)/(.+?)(\.git)?$|\1|')
            repo=$(echo "$url" | sed -E 's|.*github.com[:/](.+?)/(.+?)(\.git)?$|\2|')

            echo "üì¶ Cloning $owner/$repo..."
            git clone https://${RW_PAT}@github.com/${owner}/${repo}.git ${sub}
            cd ${sub}

            git config user.name "github-actions[bot]"
            git config user.email "github-actions[bot]@users.noreply.github.com"

            base_branch=$(git remote show origin | grep 'HEAD branch' | awk '{print $NF}')
            git fetch origin $base_branch
            git checkout -b revert-${GITHUB_RUN_ID} origin/$base_branch

            # Revert the submodule commit referenced in the parent diff
            if git cat-file -e ${new} 2>/dev/null; then
              git revert --no-edit ${new} || true
              git commit -am "Revert submodule change from parent PR" || true
              git push origin HEAD
            else
              echo "‚ö†Ô∏è Commit ${new} not found in ${repo}, skipping."
              cd ..
              continue
            fi

            # Create PR via REST
            echo "üìù Creating PR for ${owner}/${repo}..."
            pr_data=$(curl -s -X POST -H "Authorization: token ${RW_PAT}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${owner}/${repo}/pulls \
              -d "{\"title\":\"Revert submodule commit from parent PR\",\"head\":\"revert-${GITHUB_RUN_ID}\",\"base\":\"${base_branch}\",\"body\":\"Auto-revert triggered by parent repo\"}")

            pr_number=$(echo "$pr_data" | jq -r '.number')
            if [ "$pr_number" = "null" ]; then
              echo "‚ö†Ô∏è Failed to create PR for ${repo}"
              cd ..
              continue
            fi

            echo "‚úÖ Created PR #${pr_number} for ${repo}"

            # Merge PR via REST
            curl -s -X PUT -H "Authorization: token ${RW_PAT}" \
              -H "Accept: application/vnd.github+json" \
              https://api.github.com/repos/${owner}/${repo}/pulls/${pr_number}/merge \
              -d '{"merge_method":"squash"}' >/dev/null || echo "‚ö†Ô∏è Failed to merge ${repo}"

            cd ..
          done < submods.txt

      - name: Update submodules and commit to base revert branch
        run: |
          git submodule update --init --recursive
          git add .
          git commit -m "Update submodules after submodule reverts" || echo "No submodule updates"
          git push origin HEAD

      - name: Merge base revert PR (safe rebase if outdated)
        uses: actions/github-script@v7
        with:
          github-token: ${{ env.RW_PAT }}
          script: |
            const revertNumber = parseInt("${{ steps.basepr.outputs.revert_pr }}");
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            try {
              await github.rest.pulls.merge({
                owner, repo, pull_number: revertNumber, merge_method: 'squash'
              });
              core.info(`‚úÖ Successfully merged base revert PR #${revertNumber}`);
            } catch (err) {
              if (err.message.includes('out of date')) {
                core.warning('‚ö†Ô∏è Head branch out of date ‚Äì updating before merge...');
                await github.rest.pulls.updateBranch({
                  owner, repo, pull_number: revertNumber
                });
                await github.rest.pulls.merge({
                  owner, repo, pull_number: revertNumber, merge_method: 'squash'
                });
              } else {
                core.warning(`‚ùå Merge failed: ${err.message}`);
              }
            }
