name: Merge Submodule Matrix + Base PR (on /mergeMat comment)

on:
  issue_comment:
    types: [created]

permissions:
  issues: write
  pull-requests: write
  contents: write
  actions: write

env:
  # PAT with write access to both the base repo and sub‑module repos
  CROSS_TOKEN: ${{ secrets.WORKFLOWS }}
  GH_TOKEN: ${{ secrets.WORKFLOWS }}

jobs:
  # ------------------------------------------------------------------
  # 1️⃣ Detect submodules (re‑used composite)
  # ------------------------------------------------------------------
  detect-submodules:
    if: |
      github.event.issue.pull_request != null &&
      github.event.comment.body == '/mergeMat' &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest
    outputs:
      submodules: ${{ steps.detect.outputs.submodules }}
    steps:
      - name: Detect submodules (composite)
        id: detect
        uses: ./.github/actions/detect-submodules
        with:
          token: ${{ env.CROSS_TOKEN }}

  # ------------------------------------------------------------------
  # 2️⃣ Process each submodule in parallel
  # ------------------------------------------------------------------
  process-submodules:
    needs: detect-submodules
    runs-on: ubuntu-latest
    strategy:
      matrix:
        submod: ${{ fromJson(needs.detect-submodules.outputs.submodules) }}
      max-parallel: 4
    outputs:
      result: ${{ steps.subproc.outputs.result }}
    steps:
      # Checkout the base repository – needed for submodule pointer updates
      - name: Checkout base repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: true
          token: ${{ env.CROSS_TOKEN }}

      # Grab PR metadata (head / base refs) once per matrix entry
      - name: Get base PR metadata
        id: pr_info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('base_ref', pr.base.ref);
            core.setOutput('pr_number', pr.number);

      # Process the individual submodule
      - name: Process submodule (composite)
        id: subproc
        uses: ./.github/actions/process-submodule
        with:
          sub_path: ${{ matrix.submod.path }}
          sub_repo: ${{ matrix.submod.repo }}
          head_ref: ${{ steps.pr_info.outputs.head_ref }}
          base_ref: ${{ steps.pr_info.outputs.base_ref }}
          cross_token: ${{ env.CROSS_TOKEN }}
          base_repo: ${{ github.repository }}

  # ------------------------------------------------------------------
  # 3️⃣ Merge the base PR after all submodules succeeded
  # ------------------------------------------------------------------
  merge-base:
    needs: process-submodules
    runs-on: ubuntu-latest
    steps:
      - name: Get base PR number
        id: pr_info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const prNumber = context.issue.number;
            core.setOutput('pr_number', prNumber);

      - name: Merge base PR (composite)
        uses: ./.github/actions/merge-pr
        with:
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}
          number: ${{ steps.pr_info.outputs.pr_number }}
          token: ${{ secrets.GITHUB_TOKEN }}

  # ------------------------------------------------------------------
  # 4️⃣ Final comment with per‑submodule results
  # ------------------------------------------------------------------
  comment-results:
    needs: [process-submodules, merge-base]
    runs-on: ubuntu-latest
    steps:
      - name: Assemble submodule result lines
        id: aggregate
        run: |
          # Build a multi‑line string from every matrix job's `result` output
          echo "results<<EOF" >> "$GITHUB_OUTPUT"
          printf '%s\n' "${{ join(needs.process-submodules.*.outputs.result, '\n') }}" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post final comment (composite)
        uses: ./.github/actions/final-comment
        with:
          comment_id: ${{ github.event.comment.id }}
          results: ${{ steps.aggregate.outputs.results }}
          token: ${{ secrets.GITHUB_TOKEN }}
          owner: ${{ github.repository_owner }}
          repo: ${{ github.event.repository.name }}