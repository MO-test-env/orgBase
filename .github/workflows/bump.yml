name: Check and Bump Submodules

on:
  workflow_dispatch: # or change to pull_request / push triggers as needed
permissions:
  contents: write

env:
  RW_PAT: ${{ secrets.WORKFLOWS}}

jobs:
  check-and-bump-submodules:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4
        with:
          submodules: false
          fetch-depth: 1
          ref: ${{ github.ref_name }}
          token: ${{ env.RW_PAT }}

      - name: Authenticate submodules 
        run: |
          # Make sure relative paths (../repo) resolve through GitHub with a token
          git config --global url."https://${{ env.RW_PAT }}:x-oauth-basic@github.com/MO-test-env/".insteadOf "../"
          
          git submodule sync --recursive
          git submodule update --init --recursive


      - name: Current branch
        id: branch
        run: |
          echo "branch=$(git rev-parse --abbrev-ref HEAD)" >> $GITHUB_OUTPUT

      - name: Bump outdated submodules
        uses: actions/github-script@v7
        with:
          script: |
            const { execSync } = require('child_process');
            const branch = process.env.GITHUB_OUTPUT_BRANCH || process.env.GITHUB_REF_NAME;
            console.log(`üîß Branch: ${branch}`);

            const submodules = execSync('git config --file .gitmodules --get-regexp path', {encoding: 'utf8'})
              .trim().split('\n')
              .map(l => {
                const [, path] = l.split(' ');
                const name = path.split('/').pop();
                const url = execSync(`git config --file .gitmodules --get submodule.${name}.url`, {encoding: 'utf8'}).trim();
                return {name, path, url};
              });

            let changed = false;
            for (const {name, path, url} of submodules) {
              console.log(`Checking ${name}`);
              const tokenUrl = url.replace('https://', `https://${process.env.RW_PAT}@`);
              const defaultBranch = execSync(`git ls-remote --symref ${tokenUrl} HEAD | grep '^ref:' | awk '{print $2}' | sed 's|refs/heads/||'`, {encoding: 'utf8'}).trim();
              const latestCommit = execSync(`git ls-remote ${tokenUrl} refs/heads/${defaultBranch} | awk '{print $1}'`, {encoding: 'utf8'}).trim();
              const currentCommit = execSync(`git -C ${path} rev-parse HEAD`, {encoding: 'utf8'}).trim();

              if (currentCommit !== latestCommit) {
                console.log(`‚ö†Ô∏è  Submodule ${name} is outdated. Updating...`);
                execSync(`git -C ${path} fetch origin ${defaultBranch}`);
                execSync(`git -C ${path} reset --hard ${latestCommit}`);
                execSync(`git add ${path}`);
                changed = true;
              } else {
                console.log(`‚úÖ Submodule ${name} is up-to-date`);
              }
            }

            if (changed) {
              execSync('git config user.name "github-actions[bot]"');
              execSync('git config user.email "github-actions[bot]@users.noreply.dell.com"');
              execSync('git commit -m "Bump submodules to latest default branch"');
              execSync(`git push origin ${process.env.GITHUB_REF_NAME}`);
            } else {
              console.log('All submodules up‚Äëto‚Äëdate');
            }