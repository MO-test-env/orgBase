name: Check Submodules on Default Branch
on:
  push:
    branches:
      - main
env:
  CROSS_TOKEN: ${{ secrets.WORKFLOWS }}

jobs:
  check-and-bump-submodules:
    runs-on: ubuntu-latest
    env:
      CROSS_TOKEN: ${{ secrets.CROSS_TOKEN }}
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0
          token: ${{ secrets.WORKFLOWS }}

      - name: Configure Git for committing
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Verify and bump submodules if needed
        run: |
          changed=0
          git config --file .gitmodules --get-regexp path | while read -r key path; do
            name=$(basename "$path")
            url=$(git config --file .gitmodules --get "submodule.$name.url")

            # Rewrite URL for authentication
            if [[ "$url" =~ ^https:// ]]; then
              url_with_token="${url/https:\/\//https://${CROSS_TOKEN}@}"
            else
              echo "Unsupported submodule URL: $url"
              exit 1
            fi

            echo "Checking submodule $name at $path"

            # Default branch
            default_branch=$(git ls-remote --symref "$url_with_token" HEAD | grep '^ref:' | awk '{print $2}' | sed 's|refs/heads/||')
            latest_commit=$(git ls-remote "$url_with_token" "refs/heads/$default_branch" | awk '{print $1}')
            current_commit=$(git rev-parse "$path")

            if [ "$current_commit" != "$latest_commit" ]; then
              echo "⚠️  Submodule $name is outdated. Updating..."
              git submodule update --remote -- "$path"
              changed=1
            else
              echo "✅ Submodule $name is up-to-date"
            fi
          done

          if [ "$changed" -eq 1 ]; then
            echo "Committing updated submodules..."
            git add .
            git commit -m "Bump submodules to latest default branch"
            git push origin main
          else
            echo "All submodules are up-to-date, nothing to commit."
          fi