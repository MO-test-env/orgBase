name: Bump Submodule Pointer (on /bump comment)

on:
  issue_comment:
    types: [created]

# The workflow needs to read/write PRs, issues and repository contents.
permissions:
  issues: write
  pull-requests: write
  contents: write
  actions: write

# Environment variables that will be overridden at runtime.
env:
  # Placeholder for local testing ‚Äì will be replaced by the ‚ÄúGet submodule info‚Äù step.
  SUBMODULE_REPO: MOvenshire/submod
  # Token that has write access to **both** parent and submodule repos.
  CROSS_TOKEN: ${{ secrets.WORKFLOWS }}

jobs:
  bump-submodule:
    # Only run when the comment is on a PR, equals ‚Äú/bump‚Äù, and isn‚Äôt from a bot.
    if: |
      github.event.issue.pull_request != null &&
      github.event.comment.body == '/bump' &&
      github.event.comment.user.type != 'Bot'
    runs-on: ubuntu-latest
    steps:

      # ------------------------------------------------------------------
      # 1Ô∏è‚É£ Checkout the base repository (full history, **with** submodules)
      # ------------------------------------------------------------------
      - name: Checkout base repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0          # needed for rebasing submodule updates
          submodules: true
          token: ${{ env.CROSS_TOKEN }}

      # ------------------------------------------------------------------
      # 2Ô∏è‚É£ Discover submodule path and repository name from .gitmodules
      # ------------------------------------------------------------------
      - name: Get submodule info
        id: submod_info
        run: |
          echo "=== START STEP: Get submodule info ==="
          set -euxo pipefail   # show each command as it runs

          echo "üîç Extracting submodule path..."
          SUBMODULE_PATH=$(git config --file .gitmodules --get-regexp '^submodule\..*\.path$' \
            | head -1 | awk '{print $2}')
          echo "üìÅ SUBMODULE_PATH='$SUBMODULE_PATH'"

          echo "üîç Extracting submodule URL..."
          SUBMODULE_URL=$(git config --file .gitmodules --get-regexp '^submodule\..*\.url$' \
            | head -1 | awk '{print $2}')
          echo "üîó SUBMODULE_URL='$SUBMODULE_URL'"

          if [[ -z "$SUBMODULE_PATH" || -z "$SUBMODULE_URL" ]]; then
            echo "‚ùå No submodule entry found in .gitmodules"
            exit 1
          fi

          echo "üîÑ Normalising URL to owner/repo format..."
          if [[ "$SUBMODULE_URL" == git@github.com:* ]]; then
            SUBMODULE_REPO=${SUBMODULE_URL#git@github.com:}
          elif [[ "$SUBMODULE_URL" == https://github.com/* ]]; then
            SUBMODULE_REPO=${SUBMODULE_URL#https://github.com/}
          else
            echo "‚ùå Unsupported submodule URL: $SUBMODULE_URL"
            exit 1
          fi
          SUBMODULE_REPO=${SUBMODULE_REPO%.git}
          echo "‚úÖ DETECTED submodule repo='$SUBMODULE_REPO' at path='$SUBMODULE_PATH'"

          echo "submodule_path=$SUBMODULE_PATH" >> $GITHUB_OUTPUT
          echo "submodule_repo=$SUBMODULE_REPO"   >> $GITHUB_OUTPUT
          echo "=== END STEP: Get submodule info ==="

      # ------------------------------------------------------------------
      # 3Ô∏è‚É£ Get PR metadata (head ref) ‚Äì needed to push back to the PR branch
      # ------------------------------------------------------------------
      - name: Get PR metadata
        id: pr_info
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('=== START STEP: Get PR metadata ===')
            const prNumber = context.issue.number;
            console.log(`üîé Fetching PR #${prNumber}`);
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: prNumber
            });
            console.log(`‚úÖ PR head ref = ${pr.head.ref}`);
            console.log(`‚úÖ PR head SHA = ${pr.head.sha}`);
            core.setOutput('head_ref', pr.head.ref);
            core.setOutput('head_sha', pr.head.sha);
            console.log('=== END STEP: Get PR metadata ===');

      # ------------------------------------------------------------------
      # 4Ô∏è‚É£ Bump the submodule pointer to the latest `origin/main` of the submodule
      # ------------------------------------------------------------------
      - name: Bump submodule pointer
        env:
          GITHUB_TOKEN_PUSH: ${{ env.CROSS_TOKEN }}
          SUBMODULE_PATH: ${{ steps.submod_info.outputs.submodule_path }}
          SUBMODULE_REPO: ${{ steps.submod_info.outputs.submodule_repo }}
          PR_HEAD_REF: ${{ steps.pr_info.outputs.head_ref }}
        run: |
          echo "=== START STEP: Bump submodule pointer ==="
          set -euo pipefail
          echo "üîß Environment:"
          echo "  SUBMODULE_PATH=$SUBMODULE_PATH"
          echo "  SUBMODULE_REPO=$SUBMODULE_REPO"
          echo "  PR_HEAD_REF=$PR_HEAD_REF"

          # --------------------------------------------------------------
          # Ensure we have the latest PR head locally
          # --------------------------------------------------------------
          echo "üì• Fetching PR branch '$PR_HEAD_REF' from origin..."
          git fetch origin "$PR_HEAD_REF"
          echo "üîÄ Checking out branch '$PR_HEAD_REF'..."
          git checkout -B "$PR_HEAD_REF" "origin/$PR_HEAD_REF"

          # --------------------------------------------------------------
          # Initialise (or update) the submodule and fetch its main branch
          # --------------------------------------------------------------
          echo "üîÅ Updating submodule at '$SUBMODULE_PATH'..."
          git submodule update --init --depth 1 "$SUBMODULE_PATH"
          echo "üì° Fetching 'origin/main' inside submodule..."
          git -C "$SUBMODULE_PATH" fetch origin main

          # --------------------------------------------------------------
          # Compare current pointer with submodule's origin/main
          # --------------------------------------------------------------
          CURRENT_SHA=$(git -C "$SUBMODULE_PATH" rev-parse HEAD)
          ORIGIN_SHA=$(git -C "$SUBMODULE_PATH" rev-parse origin/main)
          echo "üîé Current submodule SHA: $CURRENT_SHA"
          echo "üîé Origin/main SHA:       $ORIGIN_SHA"

          if [[ "$CURRENT_SHA" == "$ORIGIN_SHA" ]]; then
            echo "‚úÖ Submodule already points to origin/main ($CURRENT_SHA). No action needed."
            echo "=== END STEP: Bump submodule pointer ==="
            exit 0
          fi

          # --------------------------------------------------------------
          # Fast‚Äëforward the submodule to the latest main commit
          # --------------------------------------------------------------
          echo "üöÄ Fast‚Äëforwarding submodule to $ORIGIN_SHA..."
          git -C "$SUBMODULE_PATH" checkout "$ORIGIN_SHA"

          # --------------------------------------------------------------
          # Commit the updated pointer in the parent repo
          # --------------------------------------------------------------
          echo "üìù Configuring git user..."
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          echo "üìÇ Staging submodule changes..."
          git add "$SUBMODULE_PATH"
          echo "üíæ Creating commit..."
          git commit -m "chore(submod): bump $SUBMODULE_REPO to main $ORIGIN_SHA"

          # --------------------------------------------------------------
          # Push the updated branch back to the PR (force‚Äëwith‚Äëlease)
          # --------------------------------------------------------------
          echo "üì§ Pushing changes back to PR branch..."
          git push "https://${GITHUB_TOKEN_PUSH}@github.com/${{ github.repository }}.git" \
            "$PR_HEAD_REF" --force-with-lease
          echo "‚úÖ Push completed."

          echo "=== END STEP: Bump submodule pointer ==="

      # ------------------------------------------------------------------
      # 5Ô∏è‚É£ Optional: Leave a comment on the PR confirming the bump
      # ------------------------------------------------------------------
      - name: Comment on PR
        if: success()
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            console.log('=== START STEP: Comment on PR ===')
            const comment = `‚úÖ Submodule \`${process.env.SUBMODULE_REPO}\` has been bumped to \`${process.env.ORIGIN_SHA || 'latest'}\`.`;
            console.log('Posting comment:', comment);
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            console.log('‚úÖ Comment posted.')
            console.log('=== END STEP: Comment on PR ===')