name: Process submodule
description: |
  For a given submodule, find the matching PR, squashâ€‘merge it,
  then bump the submodule pointer in the base repo.
author: Marissa Ovenshire

inputs:
  sub_path:
    description: Path of the submodule in the base repo
    required: true
  sub_repo:
    description: Owner/repo of the submodule
    required: true
  head_ref:
    description: Head ref of the base PR (used to locate matching subâ€‘PR)
    required: true
  base_ref:
    description: Base ref of the base PR (used for default branch fallback)
    required: true
  cross_token:
    description: PAT with write access to both repos
    required: true
  base_repo:
    description: Owner/repo of the base repository
    required: true

outputs:
  result:
    description: Humanâ€‘readable line for the final comment

runs:
  using: "composite"
  steps:
    - name: Process submodule (bash)
      id: subproc
      env:
        SUB_PATH: ${{ inputs.sub_path }}
        SUB_REPO: ${{ inputs.sub_repo }}
        HEAD_REF: ${{ inputs.head_ref }}
        BASE_REF: ${{ inputs.base_ref }}
        CROSS_TOKEN: ${{ inputs.cross_token }}
        BASE_REPO: ${{ inputs.base_repo }}
      shell: bash
      run: |
        set -euo pipefail
        echo "ðŸ”Ž Processing $SUB_REPO at $SUB_PATH"

        # 1ï¸âƒ£ Find matching PR in the submodule repo
        PR_NUM=$(gh api repos/$SUB_REPO/pulls \
          --jq ".[] | select(.head.ref==\"$HEAD_REF\") | .number" || true)

        if [[ -z "$PR_NUM" ]]; then
          echo "âš ï¸ No matching submodule PR found for $SUB_REPO â€“ skipping."
          echo "result=â€¢ $SUB_REPO: no matching PR" >> "$GITHUB_OUTPUT"
          exit 0
        fi
        echo "âœ… Found submodule PR #$PR_NUM"

        # 2ï¸âƒ£ Squashâ€‘merge the submodule PR
        gh api -X PUT \
          -H "Accept: application/vnd.github+json" \
          repos/$SUB_REPO/pulls/$PR_NUM/merge \
          -f merge_method=squash \
          -f commit_title="chore(submod): merge $SUB_REPO #$PR_NUM" \
          -f commit_message="Squashâ€‘merged submodule PR #$PR_NUM"

        # 3ï¸âƒ£ Bump submodule pointer in the base repo
        git fetch origin "$HEAD_REF"
        git checkout -B "$HEAD_REF" "origin/$HEAD_REF"
        git submodule update --init "$SUB_PATH"

        # Resolve latest SHA from submodule default branch (fallback to main)
        DEFAULT_BRANCH="${BASE_REF:-main}"
        git -C "$SUB_PATH" fetch origin "$DEFAULT_BRANCH"
        SUBMODULE_SHA=$(git -C "$SUB_PATH" rev-parse "origin/$DEFAULT_BRANCH")
        echo "Latest submodule SHA: $SUBMODULE_SHA"

        git add "$SUB_PATH"
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"

        if git diff --cached --quiet; then
          echo "No changes in submodule pointer; skipping commit."
        else
          git commit -m "chore(submod): bump $SUB_REPO to $SUBMODULE_SHA"
          git push "https://${CROSS_TOKEN}@github.com/$BASE_REPO.git" "$HEAD_REF"
        fi

        echo "result=â€¢ $SUB_REPO: merged #$PR_NUM + bumped âœ…" >> "$GITHUB_OUTPUT"
